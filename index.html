<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mami Games: PVP Arena</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { image-rendering: pixelated; -webkit-touch-callout: none; -webkit-user-select: none; }
        body { margin: 0; background: #0f0f23; overflow: hidden; font-family: 'Press Start 2P', cursive; user-select: none; touch-action: none; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f23;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; pointer-events: auto;
            border: 8px solid #3a3a5c;
            box-sizing: border-box;
        }
        
        .brand-logo {
            position: absolute; top: 20px; left: 30px;
            font-size: 16px; color: #ffcc00;
            text-shadow: 4px 4px 0px #aa8800; z-index: 30;
        }
        
        h1 { 
            color: #ff004d; 
            font-size: 24px; 
            text-shadow: 4px 4px 0px #7e0026; 
            margin: 0 0 20px 0; 
            letter-spacing: 2px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        p { color: #c2c3c7; font-size: 8px; max-width: 500px; text-align: center; line-height: 2; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        button {
            background: #29adff; 
            color: #0f0f23; 
            border: 4px solid #1d6fa5;
            padding: 12px 20px;
            font-size: 10px; 
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            box-shadow: 4px 4px 0px #1d6fa5;
            transition: all 0.1s;
        }
        button:hover { 
            background: #5fcde4; 
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px #1d6fa5;
        }
        button:active { 
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #1d6fa5;
        }
        
        .bot-btn { 
            background: #8b5cf6; 
            border-color: #5b3a9e;
            box-shadow: 4px 4px 0px #5b3a9e;
            width: 100%; 
            max-width: 280px; 
            margin-bottom: 15px; 
        }
        .bot-btn:hover { background: #a78bfa; }
        
        button.red { 
            background: #ff004d; 
            border-color: #7e0026;
            box-shadow: 4px 4px 0px #7e0026;
        }
        button.red:hover { background: #ff5577; }

        #exit-btn {
            pointer-events: auto; position: absolute; top: 15px; left: 15px;
            background: #1d2b53; border: 3px solid #3a3a5c;
            padding: 8px 15px; font-size: 8px; color: #fff;
            box-shadow: 3px 3px 0px #3a3a5c;
        }

        #room-info { 
            position: absolute; top: 15px; right: 15px; 
            color: #c2c3c7; font-size: 7px; text-align: right;
            background: #1d2b53; padding: 10px; border: 3px solid #3a3a5c;
            line-height: 2;
        }

        #health-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 200px; height: 20px; 
            background: #1d2b53; 
            border: 4px solid #ff004d;
            box-shadow: 4px 4px 0px #7e0026;
            z-index: 50;
        }
        #health-bar { 
            width: 100%; height: 100%; 
            background: #00e436;
            transition: width 0.1s steps(10);
        }
        #health-text { 
            position: absolute; bottom: 55px; left: 50%; transform: translateX(-50%); 
            color: #fff; font-size: 10px;
            text-shadow: 2px 2px 0px #000;
            z-index: 50;
        }

        #countdown {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            font-size: 48px; color: #ffec27; 
            text-shadow: 4px 4px 0px #aa8800;
            pointer-events: none; opacity: 0;
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        #notification {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 16px; color: #ffec27;
            text-shadow: 3px 3px 0px #000;
            opacity: 0;
        }

        .name-input-container {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .name-input-container label {
            color: #ffcc00;
            font-size: 8px;
        }
        #playerNameInput {
            padding: 10px 15px;
            font-size: 12px;
            font-family: 'Press Start 2P', cursive;
            border: 4px solid #ffcc00;
            background: #1d2b53;
            color: #fff;
            text-align: center;
            width: 200px;
            outline: none;
            box-shadow: 4px 4px 0px #aa8800;
        }
        #playerNameInput:focus {
            border-color: #00e436;
            box-shadow: 4px 4px 0px #00a029;
        }
        #playerNameInput::placeholder {
            color: #5f5f7a;
        }

        canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0,0,0,0.1),
                rgba(0,0,0,0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 100;
        }

        .crt-glow {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            box-shadow: inset 0 0 100px rgba(0,230,118,0.1);
            z-index: 99;
        }

        /* MOBİL KONTROLLER */
        #mobile-controls {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            pointer-events: none;
            z-index: 80;
        }

        /* D-PAD (Sol taraf) */
        #dpad {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 140px;
            height: 140px;
            pointer-events: auto;
        }

        .dpad-btn {
            position: absolute;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #fff;
            touch-action: none;
        }
        .dpad-btn:active, .dpad-btn.active {
            background: rgba(255, 236, 39, 0.6);
            border-color: #ffec27;
        }
        #dpad-up { top: 0; left: 50%; transform: translateX(-50%); border-radius: 8px 8px 0 0; }
        #dpad-down { bottom: 0; left: 50%; transform: translateX(-50%); border-radius: 0 0 8px 8px; }
        #dpad-left { left: 0; top: 50%; transform: translateY(-50%); border-radius: 8px 0 0 8px; }
        #dpad-right { right: 0; top: 50%; transform: translateY(-50%); border-radius: 0 8px 8px 0; }
        #dpad-center { 
            left: 50%; top: 50%; transform: translate(-50%, -50%); 
            width: 40px; height: 40px;
            background: rgba(0,0,0,0.3);
            border: none;
            border-radius: 4px;
        }

        /* SALDIRI BUTONU (Sağ taraf) */
        #attack-btn {
            position: absolute;
            right: 30px;
            bottom: 40px;
            width: 80px;
            height: 80px;
            background: rgba(255, 0, 77, 0.5);
            border: 4px solid #ff004d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            pointer-events: auto;
            touch-action: none;
            box-shadow: 0 0 20px rgba(255, 0, 77, 0.5);
        }
        #attack-btn:active, #attack-btn.active {
            background: rgba(255, 0, 77, 0.9);
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(255, 0, 77, 0.8);
        }

        /* Mobil cihazlarda göster */
        @media (max-width: 1024px), (pointer: coarse) {
            #mobile-controls { display: block; }
            #health-container { bottom: 190px; width: 150px; }
            #health-text { bottom: 220px; font-size: 8px; }
            h1 { font-size: 20px; }
            .brand-logo { font-size: 12px; top: 10px; left: 15px; }
            #room-info { font-size: 6px; padding: 6px; top: 10px; right: 10px; }
            #exit-btn { font-size: 6px; padding: 6px 10px; }
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="crt-glow"></div>

    <div id="mainMenu" class="overlay-screen">
        <div class="brand-logo">★ MAMI GAMES ★</div>
        <h1>PVP ARENA</h1>
        <p>SOL TIK / BUTON = SALDIRI<br>WASD / D-PAD = HAREKET<br>SON KALAN TAKIM KAZANIR!</p>
        
        <div class="name-input-container">
            <label for="playerNameInput">► OYUNCU ADI ◄</label>
            <input type="text" id="playerNameInput" placeholder="ISIM..." maxlength="8">
        </div>
        
        <div class="btn-group" style="flex-direction: column; align-items: center;">
            <button class="bot-btn" onclick="botlaOyna()">★ BOTLARLA OYNA ★</button>
            <div style="display: flex; gap: 10px;">
                <button onclick="baslat(2)">1 VS 1</button>
                <button onclick="baslat(4)">2 VS 2</button>
                <button onclick="baslat(8)">4 VS 4</button>
            </div>
        </div>
    </div>

    <div id="gameOverScreen" class="overlay-screen" style="display: none;">
        <h1 id="winnerText">GAME OVER</h1>
        <p id="subWinner">...</p>
        <div class="btn-group">
            <button onclick="location.reload()">► TEKRAR ◄</button>
            <button class="red" onclick="cikisYap()">► CIKIS ◄</button>
        </div>
    </div>

    <div id="ui-layer" style="display: none;">
        <button id="exit-btn" onclick="cikisYap()">◄ CIKIS</button>
        <div id="room-info">YUKLENIYOR...</div>
        <div id="health-text">HP: 50</div>
        <div id="health-container">
            <div id="health-bar"></div>
        </div>
        <div id="countdown"></div>
        <div id="notification"></div>
    </div>

    <!-- MOBİL KONTROLLER -->
    <div id="mobile-controls">
        <div id="dpad">
            <div id="dpad-up" class="dpad-btn">▲</div>
            <div id="dpad-down" class="dpad-btn">▼</div>
            <div id="dpad-left" class="dpad-btn">◄</div>
            <div id="dpad-right" class="dpad-btn">►</div>
            <div id="dpad-center" class="dpad-btn"></div>
        </div>
        <div id="attack-btn">SALDIRI</div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAsaLoz4P-AX6P-Pk2mzKBN1RC4Bnxlkv8",
            authDomain: "pvp-games22.firebaseapp.com",
            databaseURL: "https://pvp-games22-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pvp-games22",
            storageBucket: "pvp-games22.firebasestorage.app",
            messagingSenderId: "669194588709",
            appId: "1:669194588709:web:cf567f35e54fb8ada065cc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        const RENKLER = {
            siyah: '#0f0f23',
            koyu_mavi: '#1d2b53',
            koyu_mor: '#7e2553',
            koyu_yesil: '#008751',
            kahve: '#ab5236',
            koyu_gri: '#5f574f',
            acik_gri: '#c2c3c7',
            beyaz: '#fff1e8',
            kirmizi: '#ff004d',
            turuncu: '#ffa300',
            sari: '#ffec27',
            yesil: '#00e436',
            mavi: '#29adff',
            mor: '#83769c',
            pembe: '#ff77a8',
            krem: '#ffccaa'
        };

        let arena = { x: 0, y: 0, w: 0, h: 0, padding: 80 };
        
        let myId = "player_" + Math.floor(Math.random() * 99999);
        let oyuncuIsmi = "PLAYER";
        let odaAdi = "";
        let oyuncular = {};
        let hedefKisiSayisi = 0;
        let oyunAktif = false;
        let botModuAktif = false;
        let oyunBaslamaZamani = 0;
        let girisZamani = 0;
        let oyunBasladi = false;
        
        let takim = "mavi"; 
        let ben = {
            x: 100, y: 100, hp: 50, maxHp: 50, yon: 1, 
            hareket: false, saldiriyor: false, sonHasarZamani: 0, 
            takim: takim, isBot: false, isim: "PLAYER", girisZamani: 0
        };

        const tuslar = {};
        
        // KLAVYE KONTROLLER
        window.addEventListener('keydown', e => { tuslar[e.key] = true; if(e.code === "Space") saldir(); });
        window.addEventListener('keyup', e => tuslar[e.key] = false);
        window.addEventListener('mousedown', (e) => {
            if(e.target.id !== 'attack-btn' && !e.target.classList.contains('dpad-btn')) {
                saldir();
            }
        });

        // MOBİL KONTROLLER
        function setupMobileControls() {
            const dpadUp = document.getElementById('dpad-up');
            const dpadDown = document.getElementById('dpad-down');
            const dpadLeft = document.getElementById('dpad-left');
            const dpadRight = document.getElementById('dpad-right');
            const attackBtn = document.getElementById('attack-btn');

            // Yön tuşları
            function handleDpad(element, key) {
                element.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    tuslar[key] = true;
                    element.classList.add('active');
                }, { passive: false });
                
                element.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    tuslar[key] = false;
                    element.classList.remove('active');
                }, { passive: false });
                
                element.addEventListener('touchcancel', (e) => {
                    tuslar[key] = false;
                    element.classList.remove('active');
                });
            }

            handleDpad(dpadUp, 'w');
            handleDpad(dpadDown, 's');
            handleDpad(dpadLeft, 'a');
            handleDpad(dpadRight, 'd');

            // Saldırı butonu
            attackBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                attackBtn.classList.add('active');
                saldir();
            }, { passive: false });
            
            attackBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                attackBtn.classList.remove('active');
            }, { passive: false });
        }

        // Sayfa yüklenince mobil kontrolleri kur
        document.addEventListener('DOMContentLoaded', setupMobileControls);

        function boyutlandir() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight;
            
            // Mobil için arena boyutunu ayarla
            let isMobile = window.innerWidth <= 1024 || 'ontouchstart' in window;
            let bottomPadding = isMobile ? 200 : 80;
            
            arena.padding = Math.min(canvas.width, canvas.height) * 0.08;
            arena.x = arena.padding;
            arena.y = arena.padding + 20;
            arena.w = canvas.width - arena.padding * 2;
            arena.h = canvas.height - arena.padding * 2 - bottomPadding;
        }
        window.onresize = boyutlandir;
        boyutlandir();

        function isimAl() {
            let input = document.getElementById('playerNameInput').value.trim().toUpperCase();
            if (input.length === 0) {
                oyuncuIsmi = "P" + Math.floor(Math.random() * 999);
            } else {
                oyuncuIsmi = input;
            }
            ben.isim = oyuncuIsmi;
        }

        function botlaOyna() {
            isimAl();
            botModuAktif = true;
            takim = "mavi"; 
            let ozelOda = "bot_arena_v3_" + Math.floor(Math.random() * 100000);
            baslat(2, ozelOda); 
        }

        function baslat(kisiSayisi, ozelOdaIsmi = null) {
            isimAl();
            hedefKisiSayisi = kisiSayisi;
            odaAdi = ozelOdaIsmi ? ozelOdaIsmi : "arena_pixel_v3_" + kisiSayisi;
            oyunBaslamaZamani = Date.now();
            girisZamani = Date.now();

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            oyunAktif = true;

            if (botModuAktif) {
                takim = "mavi";
                ben.takim = takim;
                ben.isim = oyuncuIsmi;
                ben.girisZamani = girisZamani;
                ben.hp = 50;
                ben.x = arena.x + 100;
                ben.y = arena.y + arena.h / 2;

                db.ref(odaAdi + "/" + myId).set(ben);
                db.ref(odaAdi + "/" + myId).onDisconnect().remove();

                db.ref(odaAdi).on('value', snapshot => {
                    oyuncular = snapshot.val() || {};
                    if(!oyuncular[myId]) oyuncular[myId] = ben;
                    if(oyuncular[myId] && oyuncular[myId].hp !== undefined) ben.hp = oyuncular[myId].hp;
                    arayuzGuncelle();
                    kazanmaKontrolu();
                });

                document.getElementById('room-info').innerHTML = "MODE: BOT";
                geriSayimYap(3);
                oyunDongusu();
                return;
            }

            ben.isim = oyuncuIsmi;
            ben.girisZamani = girisZamani;
            ben.takim = "bekliyor";
            ben.hp = 50;
            ben.x = canvas.width / 2;
            ben.y = canvas.height / 2;

            db.ref(odaAdi).once('value').then(snapshot => {
                let mevcutOyuncular = snapshot.val() || {};
                
                Object.keys(mevcutOyuncular).forEach(key => {
                    if (mevcutOyuncular[key].isBot) db.ref(odaAdi + "/" + key).remove();
                });

                return db.ref(odaAdi + "/" + myId).set(ben);
            }).then(() => {
                db.ref(odaAdi + "/" + myId).onDisconnect().remove();

                db.ref(odaAdi).on('value', snapshot => {
                    oyuncular = snapshot.val() || {};
                    if(!oyuncular[myId]) oyuncular[myId] = ben;
                    if(oyuncular[myId] && oyuncular[myId].hp !== undefined) ben.hp = oyuncular[myId].hp;

                    let gercekOyuncular = Object.entries(oyuncular)
                        .filter(([k, p]) => !p.isBot)
                        .sort((a, b) => {
                            let zamanFark = (a[1].girisZamani || 0) - (b[1].girisZamani || 0);
                            if (zamanFark !== 0) return zamanFark;
                            return a[0].localeCompare(b[0]);
                        });

                    let benimIndex = gercekOyuncular.findIndex(([k, p]) => k === myId);
                    if (benimIndex !== -1) {
                        let yeniTakim = (benimIndex % 2 === 0) ? "mavi" : "kirmizi";
                        
                        if (ben.takim !== yeniTakim) {
                            ben.takim = yeniTakim;
                            takim = yeniTakim;
                            ben.x = takim === "mavi" ? arena.x + 100 : arena.x + arena.w - 100;
                            ben.y = arena.y + arena.h / 2;
                            db.ref(odaAdi + "/" + myId).update({ takim: yeniTakim, x: ben.x, y: ben.y });
                        }
                    }

                    arayuzGuncelle();
                    kazanmaKontrolu();
                });

                document.getElementById('room-info').innerHTML = "ROOM: " + kisiSayisi + "P";
                geriSayimYap(3);
                oyunDongusu();
            });
        }

        function geriSayimYap(saniye) {
            let cd = document.getElementById('countdown');
            cd.style.opacity = 1;
            cd.innerText = "READY!";
            
            let sayac = saniye;
            let interval = setInterval(() => {
                if(sayac > 0) {
                    cd.innerText = sayac;
                    sayac--;
                } else {
                    cd.innerText = "FIGHT!";
                    oyunBasladi = true;
                    setTimeout(() => cd.style.opacity = 0, 1000);
                    clearInterval(interval);
                }
            }, 1000);
        }

        function cikisYap() {
            if(odaAdi) db.ref(odaAdi + "/" + myId).remove();
            location.reload(); 
        }

        function arayuzGuncelle() {
            let gercekOyuncular = Object.values(oyuncular).filter(p => !p.isBot);
            let maviTakim = gercekOyuncular.filter(p => p.takim === "mavi").map(p => p.isim || "?").join(",");
            let kirmiziTakim = gercekOyuncular.filter(p => p.takim === "kirmizi").map(p => p.isim || "?").join(",");
            
            if(botModuAktif) {
                let botSayi = Object.values(oyuncular).filter(p => p.isBot).length;
                document.getElementById('room-info').innerHTML = `MODE: BOT<br>ENEMY: ${botSayi}`;
            } else {
                document.getElementById('room-info').innerHTML = 
                    `<span style="color:${RENKLER.mavi}">BLU: ${maviTakim || "..."}</span><br>` +
                    `<span style="color:${RENKLER.kirmizi}">RED: ${kirmiziTakim || "..."}</span>`;
            }
        }

        let lastBotUpdate = 0;
        function botlariYonet() {
            if (!botModuAktif) return;

            let gercekOyuncular = Object.keys(oyuncular).filter(key => !oyuncular[key].isBot).sort();
            if (gercekOyuncular.length === 0 || gercekOyuncular[0] !== myId) return;

            let mevcutSayi = Object.keys(oyuncular).length;
            
            if (mevcutSayi < hedefKisiSayisi) {
                if (Math.random() < 0.3) { 
                    let botId = "bot_" + Date.now() + Math.floor(Math.random()*100);
                    let botIsimler = ["CPU1", "CPU2", "BOT", "NPC", "AI01", "ROBO"];
                    let rastgeleIsim = botIsimler[Math.floor(Math.random() * botIsimler.length)];

                    db.ref(odaAdi + "/" + botId).set({
                        x: arena.x + arena.w - 100, 
                        y: arena.y + arena.h / 2 + (Math.random() - 0.5) * 100, 
                        hp: 50, takim: "kirmizi", isBot: true, yon: -1, hareket: false, isim: rastgeleIsim
                    });
                }
            }

            if (Date.now() - lastBotUpdate > 80) {
                Object.keys(oyuncular).forEach(key => {
                    let p = oyuncular[key];
                    if (p.isBot && p.hp > 0) {
                        let enYakinDusmanKey = null, enYakinDusman = null, minMesafe = 9999;
                        
                        Object.keys(oyuncular).forEach(targetKey => {
                            let target = oyuncular[targetKey];
                            if (target.takim !== p.takim && target.hp > 0) {
                                let d = Math.sqrt((p.x - target.x)**2 + (p.y - target.y)**2);
                                if (d < minMesafe) { minMesafe = d; enYakinDusman = target; enYakinDusmanKey = targetKey; }
                            }
                        });

                        let updates = {};
                        if (enYakinDusman) {
                            let hiz = 2;
                            if (enYakinDusman.x > p.x + 25) { p.x += hiz; p.yon = 1; p.hareket = true; }
                            else if (enYakinDusman.x < p.x - 25) { p.x -= hiz; p.yon = -1; p.hareket = true; }
                            if (enYakinDusman.y > p.y + 15) { p.y += hiz; p.hareket = true; }
                            else if (enYakinDusman.y < p.y - 15) { p.y -= hiz; p.hareket = true; }

                            p.x = Math.max(arena.x + 20, Math.min(arena.x + arena.w - 20, p.x));
                            p.y = Math.max(arena.y + 20, Math.min(arena.y + arena.h - 20, p.y));

                            if (minMesafe < 50 && !p.saldiriyor && Math.random() < 0.4) { 
                                updates.saldiriyor = true;
                                setTimeout(() => db.ref(odaAdi + "/" + key + "/saldiriyor").set(false), 400);
                                if (enYakinDusmanKey && oyuncular[enYakinDusmanKey]) {
                                    let hedefHp = oyuncular[enYakinDusmanKey].hp || 50;
                                    db.ref(odaAdi + "/" + enYakinDusmanKey + "/hp").set(Math.max(0, hedefHp - 3));
                                }
                            }
                        } else { p.hareket = false; }
                        
                        updates.x = p.x; updates.y = p.y; updates.yon = p.yon; updates.hareket = p.hareket;
                        db.ref(odaAdi + "/" + key).update(updates);
                    }
                });
                lastBotUpdate = Date.now();
            }
        }

        function saldir() {
            if (ben.saldiriyor || ben.hp <= 0) return;
            ben.saldiriyor = true;
            guncelle();
            setTimeout(() => { ben.saldiriyor = false; guncelle(); }, 300);

            Object.keys(oyuncular).forEach(key => {
                let rakip = oyuncular[key];
                if (key !== myId && rakip.hp > 0 && rakip.takim !== ben.takim) {
                    let d = Math.sqrt((rakip.x - ben.x)**2 + (rakip.y - ben.y)**2);
                    let yuzDonuk = (ben.yon === 1 && rakip.x > ben.x) || (ben.yon === -1 && rakip.x < ben.x);
                    if (d < 70 && yuzDonuk) { 
                        db.ref(odaAdi + "/" + key + "/hp").once('value').then(snapshot => {
                            let mevcutHp = snapshot.val() ?? 50;
                            db.ref(odaAdi + "/" + key + "/hp").set(Math.max(0, mevcutHp - 5));
                        });
                        bildirimGoster("HIT!");
                    }
                }
            });
        }

        function guncelle() {
            db.ref(odaAdi + "/" + myId).update({
                x: ben.x, y: ben.y, yon: ben.yon, 
                hareket: ben.hp > 0 ? ben.hareket : false, 
                saldiriyor: ben.hp > 0 ? ben.saldiriyor : false, 
                takim: ben.takim, isim: ben.isim, girisZamani: ben.girisZamani
            });
        }

        function cizArena() {
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for(let i = 0; i < canvas.width; i += 16) {
                let renk = (Math.floor(i/16) % 3 === 0) ? '#3a2a4a' : '#2a1a3a';
                ctx.fillStyle = renk;
                ctx.fillRect(i, 0, 16, arena.y - 10);
                
                if(Math.random() > 0.7) {
                    ctx.fillStyle = ['#ff004d', '#29adff', '#ffec27', '#00e436'][Math.floor(Math.random()*4)];
                    ctx.fillRect(i + 4, arena.y - 25 + Math.sin(Date.now()/500 + i)*2, 6, 6);
                }
            }
            
            for(let i = 0; i < canvas.width; i += 16) {
                let renk = (Math.floor(i/16) % 3 === 0) ? '#3a2a4a' : '#2a1a3a';
                ctx.fillStyle = renk;
                ctx.fillRect(i, arena.y + arena.h + 10, 16, canvas.height);
            }
            
            ctx.fillStyle = '#4a3a5a';
            for(let x = arena.x - 16; x <= arena.x + arena.w; x += 16) {
                ctx.fillRect(x, arena.y - 16, 16, 16);
                ctx.fillStyle = '#3a2a4a';
                ctx.fillRect(x + 2, arena.y - 14, 6, 6);
                ctx.fillStyle = '#4a3a5a';
            }
            for(let x = arena.x - 16; x <= arena.x + arena.w; x += 16) {
                ctx.fillRect(x, arena.y + arena.h, 16, 16);
            }
            for(let y = arena.y; y <= arena.y + arena.h; y += 16) {
                ctx.fillRect(arena.x - 16, y, 16, 16);
            }
            for(let y = arena.y; y <= arena.y + arena.h; y += 16) {
                ctx.fillRect(arena.x + arena.w, y, 16, 16);
            }
            
            ctx.fillStyle = '#3d2b1f';
            ctx.fillRect(arena.x, arena.y, arena.w, arena.h);
            
            for(let x = arena.x; x < arena.x + arena.w; x += 32) {
                for(let y = arena.y; y < arena.y + arena.h; y += 32) {
                    ctx.fillStyle = '#4d3b2f';
                    ctx.fillRect(x + 8, y + 8, 4, 4);
                    ctx.fillRect(x + 20, y + 16, 4, 4);
                    ctx.fillStyle = '#2d1b0f';
                    ctx.fillRect(x + 16, y + 4, 2, 2);
                }
            }
            
            ctx.fillStyle = '#5d4b3f';
            ctx.fillRect(arena.x + arena.w/2 - 2, arena.y, 4, arena.h);
            
            ctx.strokeStyle = '#5d4b3f';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(arena.x + arena.w/2, arena.y + arena.h/2, Math.min(arena.w, arena.h) * 0.15, 0, Math.PI * 2);
            ctx.stroke();
            
            cizMesale(arena.x + 20, arena.y + 20);
            cizMesale(arena.x + arena.w - 20, arena.y + 20);
            cizMesale(arena.x + 20, arena.y + arena.h - 20);
            cizMesale(arena.x + arena.w - 20, arena.y + arena.h - 20);
            
            ctx.fillStyle = '#ffec27';
            ctx.font = "12px 'Press Start 2P'";
            ctx.textAlign = "center";
            ctx.fillText("⚔ BATTLE ARENA ⚔", canvas.width/2, arena.y - 25);
            
            ctx.fillStyle = 'rgba(41, 173, 255, 0.1)';
            ctx.fillRect(arena.x, arena.y, arena.w * 0.3, arena.h);
            ctx.fillStyle = 'rgba(255, 0, 77, 0.1)';
            ctx.fillRect(arena.x + arena.w * 0.7, arena.y, arena.w * 0.3, arena.h);
            
            ctx.font = "8px 'Press Start 2P'";
            ctx.fillStyle = RENKLER.mavi;
            ctx.fillText("BLUE", arena.x + 50, arena.y + 15);
            ctx.fillStyle = RENKLER.kirmizi;
            ctx.fillText("RED", arena.x + arena.w - 50, arena.y + 15);
        }
        
        function cizMesale(x, y) {
            ctx.fillStyle = '#5f574f';
            ctx.fillRect(x - 2, y, 4, 16);
            
            let time = Date.now();
            let flicker = Math.sin(time / 100) * 2;
            
            ctx.fillStyle = '#ffa300';
            ctx.fillRect(x - 4, y - 8 + flicker, 8, 8);
            ctx.fillStyle = '#ffec27';
            ctx.fillRect(x - 2, y - 10 + flicker, 4, 6);
            ctx.fillStyle = '#ff004d';
            ctx.fillRect(x - 3, y - 4 + flicker, 6, 4);
        }

        function oyunDongusu() {
            if (!oyunAktif) return;
            
            cizArena();

            if (ben.hp > 0) {
                let hareket = false;
                let hiz = 4;
                if (tuslar['w'] || tuslar['ArrowUp']) { ben.y -= hiz; hareket = true; }
                if (tuslar['s'] || tuslar['ArrowDown']) { ben.y += hiz; hareket = true; }
                if (tuslar['a'] || tuslar['ArrowLeft']) { ben.x -= hiz; ben.yon = -1; hareket = true; }
                if (tuslar['d'] || tuslar['ArrowRight']) { ben.x += hiz; ben.yon = 1; hareket = true; }
                
                ben.x = Math.max(arena.x + 20, Math.min(arena.x + arena.w - 20, ben.x));
                ben.y = Math.max(arena.y + 20, Math.min(arena.y + arena.h - 20, ben.y));
                ben.hareket = hareket;
                guncelle(); 
            } else {
                guncelle();
            }

            let barW = Math.max(0, (ben.hp / 50) * 100);
            document.getElementById('health-bar').style.width = barW + "%";
            document.getElementById('health-bar').style.background = ben.hp > 25 ? RENKLER.yesil : RENKLER.kirmizi;
            document.getElementById('health-text').innerText = "HP: " + Math.max(0, Math.ceil(ben.hp));

            botlariYonet();
            
            let cizimSirasi = Object.entries(oyuncular).sort((a,b) => (a[1].hp <= 0 ? -1 : 1));
            cizimSirasi.forEach(([key, p]) => cizPixelKarakter(p, key));
            
            requestAnimationFrame(oyunDongusu);
        }

        function cizPixelKarakter(p, key) {
            let x = Math.floor(p.x);
            let y = Math.floor(p.y);
            let renk = p.takim === "mavi" ? RENKLER.mavi : RENKLER.kirmizi;
            let renkKoyu = p.takim === "mavi" ? '#1d6fa5' : '#7e0026';
            
            ctx.save();
            
            if (p.hp <= 0) ctx.globalAlpha = 0.5;
            
            let yon = p.yon || 1;
            let time = Date.now();
            let bounce = p.hareket ? Math.sin(time / 100) * 2 : 0;
            let saldiriOffset = p.saldiriyor ? 10 * yon : 0;
            
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(x - 10, y + 22, 20, 6);
            
            ctx.fillStyle = renkKoyu;
            if (p.hp > 0) {
                let bacakOffset = p.hareket ? Math.sin(time / 80) * 4 : 0;
                ctx.fillRect(x - 6 + bacakOffset, y + 8 + bounce, 4, 14);
                ctx.fillRect(x + 2 - bacakOffset, y + 8 + bounce, 4, 14);
            } else {
                ctx.fillRect(x - 6, y + 8, 4, 14);
                ctx.fillRect(x + 2, y + 8, 4, 14);
            }
            
            ctx.fillStyle = renk;
            ctx.fillRect(x - 8, y - 8 + bounce, 16, 18);
            
            ctx.fillStyle = renkKoyu;
            ctx.fillRect(x - 6, y - 4 + bounce, 2, 10);
            ctx.fillRect(x + 4, y - 4 + bounce, 2, 10);
            
            ctx.fillStyle = RENKLER.krem;
            ctx.fillRect(x - 6, y - 22 + bounce, 12, 14);
            
            ctx.fillStyle = renkKoyu;
            ctx.fillRect(x - 8, y - 26 + bounce, 16, 6);
            ctx.fillStyle = renk;
            ctx.fillRect(x - 6, y - 24 + bounce, 12, 4);
            
            if (p.hp > 0) {
                ctx.fillStyle = RENKLER.siyah;
                ctx.fillRect(x - 3 + (yon > 0 ? 2 : 0), y - 16 + bounce, 2, 3);
                ctx.fillRect(x + 3 + (yon > 0 ? 2 : 0), y - 16 + bounce, 2, 3);
            } else {
                ctx.fillStyle = RENKLER.kirmizi;
                ctx.fillRect(x - 4, y - 16, 2, 2);
                ctx.fillRect(x - 2, y - 14, 2, 2);
                ctx.fillRect(x + 2, y - 16, 2, 2);
                ctx.fillRect(x + 4, y - 14, 2, 2);
            }
            
            ctx.fillStyle = RENKLER.krem;
            if (yon > 0) {
                ctx.fillRect(x - 14, y - 6 + bounce, 6, 12);
                ctx.fillRect(x + 8 + saldiriOffset, y - 6 + bounce, 6, 12);
            } else {
                ctx.fillRect(x + 8, y - 6 + bounce, 6, 12);
                ctx.fillRect(x - 14 + saldiriOffset, y - 6 + bounce, 6, 12);
            }
            
            if (p.hp > 0) {
                ctx.fillStyle = '#5f574f';
                if (yon > 0) {
                    ctx.fillRect(x + 14 + saldiriOffset, y + 4 + bounce, 6, 8);
                } else {
                    ctx.fillRect(x - 20 + saldiriOffset, y + 4 + bounce, 6, 8);
                }
                
                ctx.fillStyle = RENKLER.acik_gri;
                if (yon > 0) {
                    ctx.fillRect(x + 16 + saldiriOffset, y - 16 + bounce, 4, 24);
                    ctx.fillStyle = RENKLER.beyaz;
                    ctx.fillRect(x + 17 + saldiriOffset, y - 14 + bounce, 2, 20);
                } else {
                    ctx.fillRect(x - 20 + saldiriOffset, y - 16 + bounce, 4, 24);
                    ctx.fillStyle = RENKLER.beyaz;
                    ctx.fillRect(x - 19 + saldiriOffset, y - 14 + bounce, 2, 20);
                }
                
                if (p.saldiriyor) {
                    ctx.fillStyle = 'rgba(255, 255, 200, 0.5)';
                    if (yon > 0) {
                        ctx.fillRect(x + 20 + saldiriOffset, y - 10 + bounce, 20, 4);
                    } else {
                        ctx.fillRect(x - 40 + saldiriOffset, y - 10 + bounce, 20, 4);
                    }
                }
            }
            
            ctx.fillStyle = renkKoyu;
            if (yon > 0) {
                ctx.fillRect(x - 18, y - 4 + bounce, 6, 14);
                ctx.fillStyle = renk;
                ctx.fillRect(x - 17, y - 2 + bounce, 4, 10);
            } else {
                ctx.fillRect(x + 12, y - 4 + bounce, 6, 14);
                ctx.fillStyle = renk;
                ctx.fillRect(x + 13, y - 2 + bounce, 4, 10);
            }
            
            if (p.hp > 0) {
                ctx.fillStyle = RENKLER.siyah;
                ctx.fillRect(x - 14, y - 36, 28, 8);
                ctx.fillStyle = p.hp > 25 ? RENKLER.yesil : RENKLER.kirmizi;
                ctx.fillRect(x - 13, y - 35, (p.hp / 50) * 26, 6);
            }
            
            ctx.fillStyle = RENKLER.beyaz;
            ctx.font = "8px 'Press Start 2P'";
            ctx.textAlign = "center";
            let isim = p.isim || (p.isBot ? "CPU" : "???");
            if (key === myId) isim = ">" + isim + "<";
            ctx.fillText(isim, x, y - 42);
            
            ctx.restore();
        }

        function bildirimGoster(mesaj) {
            let n = document.getElementById('notification');
            n.innerText = mesaj; n.style.opacity = 1;
            setTimeout(() => n.style.opacity = 0, 500);
        }

        function kazanmaKontrolu() {
            if (!oyunBasladi) return;

            let m = 0, k = 0;
            Object.values(oyuncular).forEach(p => {
                if (p.hp > 0) { 
                    if (p.takim === "mavi") m++; 
                    else if (p.takim === "kirmizi") k++; 
                }
            });

            let ekran = document.getElementById('gameOverScreen');
            if (ekran.style.display !== 'none') return; 

            let mainText = document.getElementById('winnerText');
            let subText = document.getElementById('subWinner');
            
            let kazananTakim = "";
            if (m === 0 && k > 0) kazananTakim = "kirmizi";
            else if (k === 0 && m > 0) kazananTakim = "mavi";
            
            if (kazananTakim !== "") {
                if (ben.takim === kazananTakim) {
                    mainText.innerText = "VICTORY!";
                    mainText.style.color = RENKLER.yesil; 
                    subText.innerText = oyuncuIsmi + " WINS!";
                } else {
                    mainText.innerText = "DEFEAT";
                    mainText.style.color = RENKLER.kirmizi; 
                    subText.innerText = "GAME OVER...";
                }
                oyunBitti();
            }
        }

        function oyunBitti() {
            oyunAktif = false;
            setTimeout(() => {
                document.getElementById('gameOverScreen').style.display = 'flex';
                document.getElementById('ui-layer').style.display = 'none';
            }, 1500); 
        }
    </script>
</body>
</html>
