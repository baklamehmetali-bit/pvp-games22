<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Mami Games: PVP Arena</title>
    <style>
        body { margin: 0; background: #222; overflow: hidden; font-family: 'Arial', sans-serif; user-select: none; }
        
        /* ARAY√úZ KATMANLARI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* MEN√úLER */
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; pointer-events: auto;
        }
        
        /* MAMI GAMES LOGOSU */
        .brand-logo {
            position: absolute;
            top: 30px;
            left: 40px;
            font-size: 32px;
            font-weight: 900;
            color: #f39c12; /* Altƒ±n Sarƒ±sƒ± / Turuncu */
            text-transform: uppercase;
            font-family: 'Verdana', sans-serif;
            letter-spacing: 2px;
            text-shadow: 3px 3px 0px #000;
            z-index: 30;
        }
        
        h1 { color: #e74c3c; font-size: 70px; text-shadow: 0 0 20px rgba(231, 76, 60, 0.5); margin: 0 0 20px 0; letter-spacing: 5px; font-weight: 900; }
        p { color: #ccc; font-size: 18px; max-width: 600px; text-align: center; line-height: 1.5; }
        
        .btn-group { display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; justify-content: center; }
        button {
            background: #3498db; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 8px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 0 #2980b9; transition: transform 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:hover { background: #5dade2; }
        
        /* BOT BUTONU */
        .bot-btn { background: #8e44ad; box-shadow: 0 4px 0 #6c3483; width: 100%; max-width: 300px; margin-bottom: 20px; }
        .bot-btn:hover { background: #9b59b6; }

        button.red { background: #e74c3c; box-shadow: 0 4px 0 #c0392b; }
        button.red:hover { background: #ec7063; }

        /* OYUN ƒ∞√áƒ∞ UI */
        #exit-btn {
            pointer-events: auto; position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 20px; font-size: 14px; color: white; border-radius: 5px; cursor: pointer;
        }
        #exit-btn:hover { background: rgba(255, 0, 0, 0.3); border-color: red; }

        #room-info {
            position: absolute; top: 20px; right: 20px;
            color: rgba(255,255,255,0.5); font-size: 14px; text-align: right;
        }

        #health-container {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 20px; background: #111; border: 2px solid #555; border-radius: 10px; overflow: hidden;
        }
        #health-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.2s; }
        #health-text { 
            position: absolute; bottom: 55px; left: 50%; transform: translateX(-50%); 
            color: white; font-weight: bold; font-size: 20px; text-shadow: 1px 1px 2px black;
        }

        #notification {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 40px; font-weight: bold; color: yellow; text-shadow: 0 0 10px black;
            opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="mainMenu" class="overlay-screen">
        <div class="brand-logo">Mami Games</div>

        <h1>PVP ARENA</h1>
        <p>Sol tƒ±k ile saldƒ±r. Takƒ±mƒ±nƒ± se√ß ve sava≈ü!</p>
        
        <div class="btn-group" style="flex-direction: column; align-items: center;">
            <button class="bot-btn" onclick="botlaOyna()">ü§ñ BOTLARLA OYNA (Tek Ki≈üilik)</button>
            <div style="display: flex; gap: 10px;">
                <button onclick="baslat(2)">‚öîÔ∏è 1 vs 1 (Online)</button>
                <button onclick="baslat(4)">‚öîÔ∏è 2 vs 2 (Online)</button>
                <button onclick="baslat(8)">‚öîÔ∏è 4 vs 4 (Online)</button>
            </div>
        </div>
    </div>

    <div id="gameOverScreen" class="overlay-screen" style="display: none;">
        <h1 id="winnerText">OYUN Bƒ∞TTƒ∞</h1>
        <p>M√ºcadele sona erdi.</p>
        <div class="btn-group">
            <button onclick="location.reload()">üîÑ Tekrar Oyna</button>
            <button class="red" onclick="cikisYap()">üè† Ana Men√º</button>
        </div>
    </div>

    <div id="ui-layer" style="display: none;">
        <button id="exit-btn" onclick="cikisYap()">‚¨Ö √áƒ±kƒ±≈ü</button>
        <div id="room-info">Oda: Bekleniyor...</div>
        <div id="health-text">50 HP</div>
        <div id="health-container">
            <div id="health-bar"></div>
        </div>
        <div id="notification"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- FIREBASE AYARLARI ---
        const firebaseConfig = {
            apiKey: "AIzaSyAsaLoz4P-AX6P-Pk2mzKBN1RC4Bnxlkv8",
            authDomain: "pvp-games22.firebaseapp.com",
            databaseURL: "https://pvp-games22-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pvp-games22",
            storageBucket: "pvp-games22.firebasestorage.app",
            messagingSenderId: "669194588709",
            appId: "1:669194588709:web:cf567f35e54fb8ada065cc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- DEƒûƒ∞≈ûKENLER ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let myId = "player_" + Math.floor(Math.random() * 99999);
        let odaAdi = "";
        let oyuncular = {};
        let hedefKisiSayisi = 0;
        let oyunAktif = false;
        let botModuAktif = false;
        
        let takim = "mavi"; 
        let ben = {
            x: 100, y: 100, hp: 50, maxHp: 50, yon: 1, 
            hareket: false, saldiriyor: false, sonHasarZamani: 0, 
            takim: takim, isBot: false
        };

        // --- KONTROLLER ---
        const tuslar = {};
        window.addEventListener('keydown', e => { tuslar[e.key] = true; if(e.code === "Space") saldir(); });
        window.addEventListener('keyup', e => tuslar[e.key] = false);
        window.addEventListener('mousedown', () => saldir());

        function boyutlandir() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = boyutlandir;
        boyutlandir();

        // --- OYUN BA≈ûLATMA ---

        function botlaOyna() {
            botModuAktif = true;
            takim = "mavi";
            let ozelOda = "bot_room_v3_" + Math.floor(Math.random() * 100000);
            baslat(4, ozelOda); 
        }

        function baslat(kisiSayisi, ozelOdaIsmi = null) {
            hedefKisiSayisi = kisiSayisi;
            odaAdi = ozelOdaIsmi ? ozelOdaIsmi : "arena_mp_v2_" + kisiSayisi;
            
            if (!botModuAktif) {
                takim = Math.random() > 0.5 ? "mavi" : "kirmizi";
            }

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            oyunAktif = true;

            ben.takim = takim;
            ben.x = takim === "mavi" ? 100 + Math.random() * 100 : canvas.width - 200 + Math.random() * 100;
            ben.y = Math.random() * (canvas.height - 100);

            db.ref(odaAdi + "/" + myId).set(ben);
            db.ref(odaAdi + "/" + myId).onDisconnect().remove();

            db.ref(odaAdi).on('value', snapshot => {
                oyuncular = snapshot.val() || {};
                arayuzGuncelle();
                kazanmaKontrolu();
            });

            document.getElementById('room-info').innerHTML = botModuAktif ? "Mod: BOTLARLA ANTRENMAN" : `Oda: ${hedefKisiSayisi} Ki≈üilik (Online)`;
            oyunDongusu();
        }

        function cikisYap() {
            if(odaAdi) db.ref(odaAdi + "/" + myId).remove();
            location.reload(); 
        }

        function arayuzGuncelle() {
            let sayi = Object.keys(oyuncular).length;
            if(!botModuAktif) {
                document.getElementById('room-info').innerHTML = `Oda: ${hedefKisiSayisi} Ki≈üilik<br>Aktif: ${sayi}/${hedefKisiSayisi}`;
            }
        }

        // --- BOT Y√ñNETƒ∞Mƒ∞ ---
        let lastBotUpdate = 0;
        function botlariYonet() {
            let ids = Object.keys(oyuncular).sort();
            if (ids[0] !== myId) return; 

            let mevcutSayi = ids.length;
            
            if (mevcutSayi < hedefKisiSayisi) {
                let spawnChance = botModuAktif ? 0.3 : 0.02; 
                if (Math.random() < spawnChance) { 
                    let botId = "bot_ai_" + Date.now() + Math.floor(Math.random()*100);
                    let botTakim;
                    if (botModuAktif) {
                        botTakim = "kirmizi";
                    } else {
                        let maviSayisi = Object.values(oyuncular).filter(p => p.takim === "mavi").length;
                        let kirmiziSayisi = Object.values(oyuncular).filter(p => p.takim === "kirmizi").length;
                        botTakim = maviSayisi <= kirmiziSayisi ? "mavi" : "kirmizi";
                    }

                    db.ref(odaAdi + "/" + botId).set({
                        x: canvas.width / 2, y: canvas.height / 2, hp: 50, 
                        takim: botTakim, isBot: true, yon: 1, hareket: false
                    });
                }
            }

            if (Date.now() - lastBotUpdate > 50) { 
                Object.keys(oyuncular).forEach(key => {
                    let p = oyuncular[key];
                    if (p.isBot && p.hp > 0) {
                        let enYakinDusman = null;
                        let minMesafe = 9999;
                        
                        Object.keys(oyuncular).forEach(targetKey => {
                            let target = oyuncular[targetKey];
                            if (target.takim !== p.takim && target.hp > 0) {
                                let d = Math.sqrt((p.x - target.x)**2 + (p.y - target.y)**2);
                                if (d < minMesafe) { minMesafe = d; enYakinDusman = target; }
                            }
                        });

                        let updates = {};
                        if (enYakinDusman) {
                            let hiz = 3.5; 
                            if (enYakinDusman.x > p.x + 40) { p.x += hiz; p.yon = 1; p.hareket = true; }
                            else if (enYakinDusman.x < p.x - 40) { p.x -= hiz; p.yon = -1; p.hareket = true; }
                            if (enYakinDusman.y > p.y + 10) { p.y += hiz; p.hareket = true; }
                            else if (enYakinDusman.y < p.y - 10) { p.y -= hiz; p.hareket = true; }

                            if (minMesafe < 70 && !p.saldiriyor) {
                                updates.saldiriyor = true;
                                setTimeout(() => db.ref(odaAdi + "/" + key + "/saldiriyor").set(false), 300);
                                if (Math.random() > 0.4) { 
                                     Object.keys(oyuncular).forEach(k => {
                                        if (oyuncular[k] === enYakinDusman) {
                                            db.ref(odaAdi + "/" + k + "/hp").transaction(h => (h || 50) - 3); 
                                        }
                                     });
                                }
                            }
                        } else { p.hareket = false; }
                        
                        updates.x = p.x; updates.y = p.y; updates.yon = p.yon; updates.hareket = p.hareket;
                        db.ref(odaAdi + "/" + key).update(updates);
                    }
                });
                lastBotUpdate = Date.now();
            }
        }

        // --- AKSƒ∞YON ---
        function saldir() {
            if (ben.saldiriyor || ben.hp <= 0) return;
            ben.saldiriyor = true;
            guncelle();
            setTimeout(() => { ben.saldiriyor = false; guncelle(); }, 300);

            Object.keys(oyuncular).forEach(key => {
                let rakip = oyuncular[key];
                if (key !== myId && rakip.takim !== ben.takim && rakip.hp > 0) {
                    let d = Math.sqrt((rakip.x - ben.x)**2 + (rakip.y - ben.y)**2);
                    let yuzDonuk = (ben.yon === 1 && rakip.x > ben.x) || (ben.yon === -1 && rakip.x < ben.x);
                    if (d < 100 && yuzDonuk) { 
                        db.ref(odaAdi + "/" + key + "/hp").transaction(val => (val || 50) - 5);
                        db.ref(odaAdi + "/" + key + "/sonHasarZamani").set(Date.now());
                        bildirimGoster("VURDUN!");
                    }
                }
            });
        }

        function guncelle() {
            if (ben.hp <= 0) return;
            db.ref(odaAdi + "/" + myId).update({
                x: ben.x, y: ben.y, yon: ben.yon, 
                hareket: ben.hareket, saldiriyor: ben.saldiriyor, takim: ben.takim
            });
        }

        function oyunDongusu() {
            if (!oyunAktif) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (ben.hp > 0) {
                let hareket = false;
                let hiz = 5;
                if (tuslar['w'] || tuslar['ArrowUp']) { ben.y -= hiz; hareket = true; }
                if (tuslar['s'] || tuslar['ArrowDown']) { ben.y += hiz; hareket = true; }
                if (tuslar['a'] || tuslar['ArrowLeft']) { ben.x -= hiz; ben.yon = -1; hareket = true; }
                if (tuslar['d'] || tuslar['ArrowRight']) { ben.x += hiz; ben.yon = 1; hareket = true; }
                
                ben.x = Math.max(0, Math.min(canvas.width, ben.x));
                ben.y = Math.max(0, Math.min(canvas.height, ben.y));
                ben.hareket = hareket;
                if (hareket) guncelle();

                if (ben.hp < 50 && Date.now() - ben.sonHasarZamani > 5000) {
                    ben.hp += 0.05;
                    if(Math.floor(ben.hp*10) % 5 === 0) db.ref(odaAdi + "/" + myId + "/hp").set(ben.hp);
                }
            }

            let barW = Math.max(0, (ben.hp / 50) * 100);
            document.getElementById('health-bar').style.width = barW + "%";
            document.getElementById('health-text').innerText = Math.ceil(ben.hp) + " HP";

            botlariYonet();
            Object.values(oyuncular).sort((a,b) => a.y - b.y).forEach(p => cizKarakter(p));
            requestAnimationFrame(oyunDongusu);
        }

        function cizKarakter(p) {
            if (p.hp <= 0) return; 

            ctx.save();
            ctx.translate(p.x, p.y);
            
            ctx.fillStyle = "white"; ctx.font = "bold 12px Arial"; ctx.textAlign = "center";
            let isim = p.isBot ? "[BOT]" : "OYUNCU";
            if (p.id === myId) isim = "BEN";
            ctx.fillText(isim, 0, -55);

            ctx.fillStyle = "red"; ctx.fillRect(-20, -45, 40, 6);
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(-20, -45, (Math.max(0, p.hp) / 50) * 40, 6);

            ctx.scale(p.yon, 1);
            ctx.strokeStyle = p.takim === "mavi" ? "#3498db" : "#e74c3c";
            ctx.lineWidth = 3; ctx.lineCap = "round"; ctx.lineJoin = "round";

            let time = Date.now();
            let bacakHizi = p.hareket ? Math.sin(time / 80) * 10 : 0;
            
            ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(0, 10); ctx.stroke(); 
            ctx.beginPath(); ctx.arc(0, -30, 10, 0, Math.PI*2); ctx.stroke(); 
            ctx.fillStyle = p.takim === "mavi" ? "cyan" : "orange"; 
            ctx.beginPath(); ctx.arc(4, -30, 2, 0, Math.PI*2); ctx.fill();

            ctx.beginPath(); ctx.moveTo(0, 10); ctx.lineTo(-10 + bacakHizi, 35); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, 10); ctx.lineTo(5 - bacakHizi, 35); ctx.stroke();

            let kolAcisi = p.saldiriyor ? -Math.PI / 1.5 : 0;
            ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(-10, 5); ctx.stroke();
            
            ctx.save();
            ctx.translate(0, -15);
            ctx.rotate(kolAcisi + (p.hareket ? Math.sin(time/80)*0.2 : 0));
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(15, 5); ctx.stroke(); 
            ctx.strokeStyle = "#ecf0f1"; ctx.lineWidth = 4; 
            ctx.beginPath(); ctx.moveTo(15, 5); ctx.lineTo(55, -5); ctx.stroke();
            ctx.restore();
            ctx.restore();
        }

        function bildirimGoster(mesaj) {
            let n = document.getElementById('notification');
            n.innerText = mesaj; n.style.opacity = 1;
            setTimeout(() => n.style.opacity = 0, 1000);
        }

        function kazanmaKontrolu() {
            let m = 0, k = 0;
            Object.values(oyuncular).forEach(p => {
                if (p.hp > 0) { if (p.takim === "mavi") m++; else k++; }
            });

            let toplamCanli = m + k;
            if (toplamCanli < 2) return;

            let ekran = document.getElementById('gameOverScreen');
            if (ekran.style.display !== 'none') return; 

            let text = document.getElementById('winnerText');
            if (m === 0 && k > 0) {
                text.innerText = "MAVƒ∞ TAKIM KAZANDI!";
                text.style.color = "#3498db";
                oyunBitti();
            } else if (k === 0 && m > 0) {
                text.innerText = "KIRMIZI TAKIM KAZANDI!";
                text.style.color = "#e74c3c";
                oyunBitti();
            }
        }

        function oyunBitti() {
            oyunAktif = false;
            setTimeout(() => {
                document.getElementById('gameOverScreen').style.display = 'flex';
                document.getElementById('ui-layer').style.display = 'none';
            }, 1000);
        }
    </script>
</body>
</html>
