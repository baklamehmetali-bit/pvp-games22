<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mami Games: PVP Arena</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { image-rendering: pixelated; -webkit-touch-callout: none; -webkit-user-select: none; box-sizing: border-box; }
        body { margin: 0; background: #0f0f23; overflow: hidden; font-family: 'Press Start 2P', cursive; user-select: none; touch-action: none; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0f23;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; pointer-events: auto;
            border: 8px solid #3a3a5c;
            overflow-y: auto;
            padding: 20px;
        }
        
        .brand-logo {
            position: absolute; top: 20px; left: 30px;
            font-size: 16px; color: #ffcc00;
            z-index: 30;
        }
        
        h1 { 
            color: #ff004d; 
            font-size: 24px; 
            margin: 0 0 15px 0; 
            letter-spacing: 2px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        p { color: #c2c3c7; font-size: 8px; max-width: 500px; text-align: center; line-height: 2; margin: 5px 0; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }
        button {
            background: #29adff; 
            color: #0f0f23; 
            border: 4px solid #1d6fa5;
            padding: 12px 20px;
            font-size: 10px; 
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            box-shadow: 4px 4px 0px #1d6fa5;
            transition: all 0.1s;
        }
        button:hover { background: #5fcde4; }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #1d6fa5; }
        
        .bot-btn { 
            background: #8b5cf6; border-color: #5b3a9e;
            box-shadow: 4px 4px 0px #5b3a9e;
            width: 100%; max-width: 280px; margin-bottom: 10px; 
        }
        .bot-btn:hover { background: #a78bfa; }
        
        button.red { background: #ff004d; border-color: #7e0026; box-shadow: 4px 4px 0px #7e0026; }
        button.red:hover { background: #ff5577; }
        
        button.green { background: #00e436; border-color: #00a029; box-shadow: 4px 4px 0px #00a029; }
        button.green:hover { background: #5fcf7a; }
        
        button.orange { background: #ffa300; border-color: #aa6b00; box-shadow: 4px 4px 0px #aa6b00; }
        button.orange:hover { background: #ffbf4d; }

        #exit-btn {
            pointer-events: auto; position: absolute; top: 15px; left: 15px;
            background: #1d2b53; border: 3px solid #3a3a5c;
            padding: 8px 15px; font-size: 8px; color: #fff;
            box-shadow: 3px 3px 0px #3a3a5c;
        }

        #room-info { 
            position: absolute; top: 15px; right: 15px; 
            color: #c2c3c7; font-size: 7px; text-align: right;
            background: #1d2b53; padding: 10px; border: 3px solid #3a3a5c;
            line-height: 2;
        }

        #health-container {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 200px; height: 20px; 
            background: #1d2b53; border: 4px solid #ff004d;
            box-shadow: 4px 4px 0px #7e0026; z-index: 50;
        }
        #health-bar { width: 100%; height: 100%; background: #00e436; transition: width 0.1s steps(10); }
        #health-text { 
            position: absolute; bottom: 55px; left: 50%; transform: translateX(-50%); 
            color: #fff; font-size: 10px; text-shadow: 2px 2px 0px #000; z-index: 50;
        }
        
        #regen-indicator {
            position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%);
            color: #00e436; font-size: 8px; text-shadow: 2px 2px 0px #000;
            z-index: 50; opacity: 0; transition: opacity 0.3s;
        }

        #countdown {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            font-size: 48px; color: #ffec27; text-shadow: 4px 4px 0px #aa8800;
            pointer-events: none; opacity: 0;
        }

        #notification {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 16px; color: #ffec27; text-shadow: 3px 3px 0px #000; opacity: 0;
        }

        /* AUTH EKRANI */
        #authScreen { z-index: 25; }
        .auth-container { 
            background: #1d2b53; padding: 30px; border: 4px solid #3a3a5c;
            display: flex; flex-direction: column; gap: 15px; align-items: center;
            max-width: 320px; width: 90%;
        }
        .auth-container input {
            padding: 10px 15px; font-size: 10px; font-family: 'Press Start 2P', cursive;
            border: 3px solid #3a3a5c; background: #0f0f23; color: #fff;
            width: 100%; outline: none;
        }
        .auth-container input:focus { border-color: #ffcc00; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .auth-tab { 
            padding: 10px 20px; background: #3a3a5c; color: #fff; 
            border: none; cursor: pointer; font-family: 'Press Start 2P', cursive; font-size: 8px;
        }
        .auth-tab.active { background: #ffcc00; color: #0f0f23; }
        #authError { color: #ff004d; font-size: 8px; text-align: center; min-height: 20px; }

        /* PROFIL B√ñL√úM√ú */
        .profile-bar {
            position: absolute; top: 60px; left: 30px;
            background: #1d2b53; padding: 10px 15px; border: 3px solid #3a3a5c;
            font-size: 8px; color: #fff; z-index: 30;
        }
        .profile-bar span { color: #ffcc00; }

        /* MAƒûAZA */
        #shopScreen { z-index: 22; display: none; }
        .shop-container {
            background: #1d2b53; padding: 20px; border: 4px solid #ffcc00;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .shop-item {
            display: flex; align-items: center; justify-content: space-between;
            background: #0f0f23; padding: 15px; margin: 10px 0; border: 2px solid #3a3a5c;
        }
        .shop-item.owned { border-color: #00e436; }
        .shop-item.equipped { border-color: #ffcc00; background: #2d1b53; }
        .shop-item-info { display: flex; align-items: center; gap: 15px; }
        .shop-item-icon { width: 40px; height: 40px; background: #3a3a5c; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .shop-item-details { font-size: 8px; }
        .shop-item-name { color: #fff; margin-bottom: 5px; }
        .shop-item-desc { color: #c2c3c7; }
        .shop-item-price { color: #ffcc00; font-size: 10px; }
        .shop-item button { padding: 8px 12px; font-size: 8px; }

        /* JOYSTICK */
        #joystick-container {
            position: fixed; left: 30px; bottom: 30px;
            width: 120px; height: 120px; display: none; z-index: 80;
            pointer-events: auto; touch-action: none;
        }
        #joystick-base {
            width: 120px; height: 120px; background: rgba(255,255,255,0.15);
            border: 4px solid rgba(255,255,255,0.3); border-radius: 50%;
            position: relative;
        }
        #joystick-thumb {
            width: 50px; height: 50px; background: rgba(255,236,39,0.7);
            border: 3px solid #ffcc00; border-radius: 50%;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: none;
        }

        #attack-btn {
            position: fixed; right: 30px; bottom: 50px;
            width: 80px; height: 80px;
            background: rgba(255, 0, 77, 0.5); border: 4px solid #ff004d;
            border-radius: 50%; display: none; align-items: center; justify-content: center;
            font-size: 10px; color: #fff; font-family: 'Press Start 2P', cursive;
            z-index: 80; pointer-events: auto; touch-action: none;
            box-shadow: 0 0 20px rgba(255, 0, 77, 0.5);
        }
        #attack-btn:active, #attack-btn.active {
            background: rgba(255, 0, 77, 0.9); transform: scale(0.95);
        }

        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
            z-index: 100;
        }

        .crt-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; box-shadow: inset 0 0 100px rgba(0,230,118,0.1); z-index: 99;
        }

        canvas { image-rendering: pixelated; image-rendering: crisp-edges; }

        /* MOBƒ∞L RESPONSIVE */
        @media (max-width: 1024px), (pointer: coarse) {
            #health-container { bottom: 160px; width: 150px; }
            #health-text { bottom: 190px; font-size: 8px; }
            #regen-indicator { bottom: 220px; }
            h1 { font-size: 18px; }
            .brand-logo { font-size: 12px; top: 10px; left: 15px; }
            #room-info { font-size: 6px; padding: 6px; top: 10px; right: 10px; }
            #exit-btn { font-size: 6px; padding: 6px 10px; }
            .profile-bar { top: 45px; left: 10px; font-size: 6px; padding: 6px 10px; }
        }

        /* LANDSCAPE MODE FIX */
        @media (max-height: 500px) and (orientation: landscape) {
            #joystick-container { left: 20px; bottom: 20px; width: 100px; height: 100px; }
            #joystick-base { width: 100px; height: 100px; }
            #joystick-thumb { width: 40px; height: 40px; }
            #attack-btn { right: 20px; bottom: 20px; width: 70px; height: 70px; font-size: 8px; }
            #health-container { bottom: 10px; width: 120px; height: 15px; }
            #health-text { bottom: 30px; font-size: 7px; }
            #regen-indicator { bottom: 50px; font-size: 6px; }
            #room-info { font-size: 5px; padding: 4px; }
            #exit-btn { font-size: 5px; padding: 4px 8px; top: 5px; left: 5px; }
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="crt-glow"></div>

    <!-- AUTH EKRANI -->
    <div id="authScreen" class="overlay-screen">
        <div class="brand-logo">‚òÖ MAMI GAMES ‚òÖ</div>
        <h1>PVP ARENA</h1>
        <div class="auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Gƒ∞Rƒ∞≈û</button>
                <button class="auth-tab" onclick="showAuthTab('register')">KAYIT</button>
            </div>
            <input type="email" id="authEmail" placeholder="E-POSTA...">
            <input type="password" id="authPassword" placeholder="≈ûƒ∞FRE...">
            <div id="authError"></div>
            <button id="authBtn" class="green" onclick="handleAuth()">Gƒ∞Rƒ∞≈û YAP</button>
            <button onclick="playAsGuest()" style="background: #5f574f; border-color: #3a3a3a;">Mƒ∞SAFƒ∞R OYNA</button>
        </div>
    </div>

    <!-- ANA MEN√ú -->
    <div id="mainMenu" class="overlay-screen" style="display: none;">
        <div class="brand-logo">‚òÖ MAMI GAMES ‚òÖ</div>
        <div class="profile-bar" id="profileBar">
            OYUNCU: <span id="profileName">-</span><br>
            PUAN: <span id="profileScore">0</span> ‚≠ê
        </div>
        <h1>PVP ARENA</h1>
        <p>30 SN VURULMAZSAN HP YENƒ∞LENƒ∞R!<br>SON KALAN TAKIM KAZANIR!</p>
        
        <div class="btn-group" style="flex-direction: column; align-items: center;">
            <button class="bot-btn" onclick="botlaOyna()">‚òÖ BOTLARLA OYNA ‚òÖ</button>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button onclick="baslat(2)">1 VS 1</button>
                <button onclick="baslat(4)">2 VS 2</button>
                <button onclick="baslat(8)">4 VS 4</button>
            </div>
            <button class="orange" onclick="openShop()" style="margin-top: 15px;">üõí MAƒûAZA</button>
            <button class="red" onclick="logout()" style="margin-top: 10px; font-size: 8px; padding: 8px 15px;">√áIKI≈û YAP</button>
        </div>
    </div>

    <!-- MAƒûAZA -->
    <div id="shopScreen" class="overlay-screen">
        <div class="shop-container">
            <h1 style="font-size: 16px; text-align: center;">üõí MAƒûAZA</h1>
            <p>Puan kazanarak √∂d√ºller a√ß! Her galibiyet +5 puan.</p>
            <div id="shopItems"></div>
            <button class="red" onclick="closeShop()" style="width: 100%; margin-top: 15px;">KAPAT</button>
        </div>
    </div>

    <!-- OYUN Bƒ∞TTƒ∞ EKRANI -->
    <div id="gameOverScreen" class="overlay-screen" style="display: none;">
        <h1 id="winnerText">GAME OVER</h1>
        <p id="subWinner">...</p>
        <p id="scoreGain" style="color: #ffcc00;"></p>
        <div class="btn-group">
            <button onclick="location.reload()">‚ñ∫ TEKRAR ‚óÑ</button>
            <button class="red" onclick="cikisYap()">‚ñ∫ MEN√ú ‚óÑ</button>
        </div>
    </div>

    <!-- OYUN UI -->
    <div id="ui-layer" style="display: none;">
        <button id="exit-btn" onclick="cikisYap()">‚óÑ √áIKI≈û</button>
        <div id="room-info">YUKLENIYOR...</div>
        <div id="regen-indicator">‚ô• REGEN ‚ô•</div>
        <div id="health-text">HP: 50</div>
        <div id="health-container">
            <div id="health-bar"></div>
        </div>
        <div id="countdown"></div>
        <div id="notification"></div>
    </div>

    <!-- MOBƒ∞L KONTROLLER -->
    <div id="joystick-container">
        <div id="joystick-base">
            <div id="joystick-thumb"></div>
        </div>
    </div>
    <div id="attack-btn">SALDIRI</div>

    <canvas id="gameCanvas"></canvas>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAsaLoz4P-AX6P-Pk2mzKBN1RC4Bnxlkv8",
            authDomain: "pvp-games22.firebaseapp.com",
            databaseURL: "https://pvp-games22-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "pvp-games22",
            storageBucket: "pvp-games22.firebasestorage.app",
            messagingSenderId: "669194588709",
            appId: "1:669194588709:web:cf567f35e54fb8ada065cc"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        const RENKLER = {
            siyah: '#0f0f23', koyu_mavi: '#1d2b53', koyu_mor: '#7e2553',
            koyu_yesil: '#008751', kahve: '#ab5236', koyu_gri: '#5f574f',
            acik_gri: '#c2c3c7', beyaz: '#fff1e8', kirmizi: '#ff004d',
            turuncu: '#ffa300', sari: '#ffec27', yesil: '#00e436',
            mavi: '#29adff', mor: '#83769c', pembe: '#ff77a8', krem: '#ffccaa'
        };

        const AYARLAR = {
            regenSuresi: 30000, regenMiktari: 2, maxHp: 50,
            oyuncuHasar: 5, botHasar: 3, oyuncuHiz: 4, botHiz: 3.5,
            galibiyetPuani: 5
        };

        // MAƒûAZA √ñƒûELERƒ∞
        const MAGAZA = [
            { id: 'sword2', name: '√áƒ∞FT KILI√á', desc: '+2 Hasar', icon: '‚öîÔ∏è', puan: 50, tip: 'silah', bonus: { hasar: 2 } },
            { id: 'armor1', name: 'DEMƒ∞R ZIRH', desc: '+10 HP', icon: 'üõ°Ô∏è', puan: 100, tip: 'zirh', bonus: { hp: 10 } },
            { id: 'boots1', name: 'HIZ BOTLARI', desc: '+1 Hƒ±z', icon: 'üë¢', puan: 75, tip: 'bot', bonus: { hiz: 1 } },
            { id: 'helmet1', name: 'ALTIN KASK', desc: '+5 HP', icon: '‚õëÔ∏è', puan: 60, tip: 'kask', bonus: { hp: 5 } },
            { id: 'sword3', name: 'ATE≈û KILICI', desc: '+4 Hasar', icon: 'üî•', puan: 150, tip: 'silah', bonus: { hasar: 4 } },
            { id: 'armor2', name: 'ELMAS ZIRH', desc: '+20 HP', icon: 'üíé', puan: 200, tip: 'zirh', bonus: { hp: 20 } },
        ];

        let arena = { x: 0, y: 0, w: 0, h: 0, padding: 80 };
        let myId = "player_" + Math.floor(Math.random() * 99999);
        let oyuncuIsmi = "PLAYER";
        let odaAdi = "";
        let oyuncular = {};
        let hedefKisiSayisi = 0;
        let oyunAktif = false;
        let botModuAktif = false;
        let oyunBaslamaZamani = 0;
        let girisZamani = 0;
        let oyunBasladi = false;
        let sonRegenZamani = 0;
        let authMode = 'login';
        let currentUser = null;
        let userProfile = { puan: 0, sahipOlunanlar: [], equiped: {} };
        let isMobile = false;
        
        let takim = "mavi"; 
        let ben = {
            x: 100, y: 100, hp: 50, maxHp: 50, yon: 1, 
            hareket: false, saldiriyor: false, sonHasarZamani: 0, 
            takim: takim, isBot: false, isim: "PLAYER", girisZamani: 0
        };

        const tuslar = {};
        let joystickActive = false;
        let joystickData = { x: 0, y: 0 };

        // AUTH FONKSƒ∞YONLARI
        function showAuthTab(tab) {
            authMode = tab;
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('authBtn').innerText = tab === 'login' ? 'Gƒ∞Rƒ∞≈û YAP' : 'KAYIT OL';
            document.getElementById('authError').innerText = '';
        }

        function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');
            
            if (!email || !password) {
                errorEl.innerText = 'T√ºm alanlarƒ± doldurun!';
                return;
            }

            if (authMode === 'login') {
                auth.signInWithEmailAndPassword(email, password)
                    .then(userCredential => onAuthSuccess(userCredential.user))
                    .catch(err => errorEl.innerText = 'Hatalƒ± giri≈ü!');
            } else {
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        // Yeni kullanƒ±cƒ± profili olu≈ütur
                        db.ref('users/' + userCredential.user.uid).set({
                            email: email,
                            puan: 0,
                            sahipOlunanlar: [],
                            equiped: {},
                            olusturulma: Date.now()
                        });
                        onAuthSuccess(userCredential.user);
                    })
                    .catch(err => errorEl.innerText = 'Kayƒ±t ba≈üarƒ±sƒ±z!');
            }
        }

        function playAsGuest() {
            currentUser = null;
            oyuncuIsmi = "MISAFIR_" + Math.floor(Math.random() * 999);
            userProfile = { puan: 0, sahipOlunanlar: [], equiped: {} };
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            updateProfileUI();
        }

        function onAuthSuccess(user) {
            currentUser = user;
            db.ref('users/' + user.uid).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    userProfile = snapshot.val();
                } else {
                    userProfile = { puan: 0, sahipOlunanlar: [], equiped: {} };
                }
                oyuncuIsmi = user.email.split('@')[0].toUpperCase().substring(0, 8);
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainMenu').style.display = 'flex';
                updateProfileUI();
            });
        }

        function logout() {
            auth.signOut().then(() => location.reload());
        }

        function updateProfileUI() {
            document.getElementById('profileName').innerText = oyuncuIsmi;
            document.getElementById('profileScore').innerText = userProfile.puan || 0;
        }

        function saveUserProfile() {
            if (currentUser) {
                db.ref('users/' + currentUser.uid).update(userProfile);
            }
        }

        // MAƒûAZA FONKSƒ∞YONLARI
        function openShop() {
            document.getElementById('shopScreen').style.display = 'flex';
            renderShopItems();
        }

        function closeShop() {
            document.getElementById('shopScreen').style.display = 'none';
        }

        function renderShopItems() {
            const container = document.getElementById('shopItems');
            container.innerHTML = '';
            
            MAGAZA.forEach(item => {
                const owned = userProfile.sahipOlunanlar?.includes(item.id);
                const equipped = userProfile.equiped?.[item.tip] === item.id;
                
                const div = document.createElement('div');
                div.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');
                
                let btnHtml = '';
                if (owned) {
                    if (equipped) {
                        btnHtml = `<button disabled style="background:#5f574f">TAKILDI</button>`;
                    } else {
                        btnHtml = `<button class="green" onclick="equipItem('${item.id}', '${item.tip}')">TAK</button>`;
                    }
                } else {
                    const canBuy = (userProfile.puan || 0) >= item.puan;
                    btnHtml = `<button ${canBuy ? '' : 'disabled'} onclick="buyItem('${item.id}')">${item.puan} ‚≠ê</button>`;
                }
                
                div.innerHTML = `
                    <div class="shop-item-info">
                        <div class="shop-item-icon">${item.icon}</div>
                        <div class="shop-item-details">
                            <div class="shop-item-name">${item.name}</div>
                            <div class="shop-item-desc">${item.desc}</div>
                        </div>
                    </div>
                    ${btnHtml}
                `;
                container.appendChild(div);
            });
        }

        function buyItem(itemId) {
            const item = MAGAZA.find(i => i.id === itemId);
            if (!item || (userProfile.puan || 0) < item.puan) return;
            
            userProfile.puan -= item.puan;
            if (!userProfile.sahipOlunanlar) userProfile.sahipOlunanlar = [];
            userProfile.sahipOlunanlar.push(itemId);
            
            saveUserProfile();
            updateProfileUI();
            renderShopItems();
            alert(item.name + ' satƒ±n alƒ±ndƒ±!');
        }

        function equipItem(itemId, tip) {
            if (!userProfile.equiped) userProfile.equiped = {};
            userProfile.equiped[tip] = itemId;
            saveUserProfile();
            renderShopItems();
        }

        function getPlayerBonuses() {
            let bonuses = { hasar: 0, hp: 0, hiz: 0 };
            if (userProfile.equiped) {
                Object.values(userProfile.equiped).forEach(itemId => {
                    const item = MAGAZA.find(i => i.id === itemId);
                    if (item && item.bonus) {
                        if (item.bonus.hasar) bonuses.hasar += item.bonus.hasar;
                        if (item.bonus.hp) bonuses.hp += item.bonus.hp;
                        if (item.bonus.hiz) bonuses.hiz += item.bonus.hiz;
                    }
                });
            }
            return bonuses;
        }

        // KLAVYE KONTROLLER
        window.addEventListener('keydown', e => { tuslar[e.key] = true; if(e.code === "Space") saldir(); });
        window.addEventListener('keyup', e => tuslar[e.key] = false);
        window.addEventListener('mousedown', (e) => {
            if(e.target.id !== 'attack-btn' && e.target.id !== 'joystick-base' && e.target.id !== 'joystick-thumb') {
                if (oyunAktif) saldir();
            }
        });

        // JOYSTICK KONTROLLER
        function setupJoystick() {
            const container = document.getElementById('joystick-container');
            const base = document.getElementById('joystick-base');
            const thumb = document.getElementById('joystick-thumb');
            
            function handleJoystick(e) {
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                const rect = base.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                const maxDist = rect.width / 2 - 25;
                const dist = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (dist > maxDist) {
                    deltaX = (deltaX / dist) * maxDist;
                    deltaY = (deltaY / dist) * maxDist;
                }
                
                thumb.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                
                joystickData.x = deltaX / maxDist;
                joystickData.y = deltaY / maxDist;
                joystickActive = true;
            }
            
            function resetJoystick() {
                thumb.style.transform = 'translate(-50%, -50%)';
                joystickData.x = 0;
                joystickData.y = 0;
                joystickActive = false;
            }
            
            container.addEventListener('touchstart', handleJoystick, { passive: false });
            container.addEventListener('touchmove', handleJoystick, { passive: false });
            container.addEventListener('touchend', resetJoystick);
            container.addEventListener('touchcancel', resetJoystick);
        }

        function setupAttackButton() {
            const attackBtn = document.getElementById('attack-btn');
            
            attackBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                attackBtn.classList.add('active');
                saldir();
            }, { passive: false });
            
            attackBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                attackBtn.classList.remove('active');
            }, { passive: false });
        }

        function showMobileControls(show) {
            const joystick = document.getElementById('joystick-container');
            const attackBtn = document.getElementById('attack-btn');
            
            if (isMobile && show) {
                joystick.style.display = 'block';
                attackBtn.style.display = 'flex';
            } else {
                joystick.style.display = 'none';
                attackBtn.style.display = 'none';
            }
        }

        function checkMobile() {
            isMobile = window.innerWidth <= 1024 || 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkMobile();
            setupJoystick();
            setupAttackButton();
            
            // Auth state listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    onAuthSuccess(user);
                }
            });
        });

        function boyutlandir() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight;
            checkMobile();
            
            let bottomPadding = isMobile ? 180 : 80;
            if (window.innerHeight < 500) bottomPadding = 120; // Landscape
            
            arena.padding = Math.min(canvas.width, canvas.height) * 0.08;
            arena.x = arena.padding;
            arena.y = arena.padding + 20;
            arena.w = canvas.width - arena.padding * 2;
            arena.h = canvas.height - arena.padding * 2 - bottomPadding;
        }
        window.onresize = boyutlandir;
        boyutlandir();

        function botlaOyna() {
            botModuAktif = true;
            takim = "mavi"; 
            let ozelOda = "bot_arena_v5_" + Math.floor(Math.random() * 100000);
            baslat(2, ozelOda); 
        }

        function baslat(kisiSayisi, ozelOdaIsmi = null) {
            ben.isim = oyuncuIsmi;
            hedefKisiSayisi = kisiSayisi;
            odaAdi = ozelOdaIsmi ? ozelOdaIsmi : "arena_pixel_v5_" + kisiSayisi;
            
            // Oda doluluƒüu kontrol√º (bot modu hari√ß)
            if (!ozelOdaIsmi) {
                db.ref(odaAdi).once('value').then(snapshot => {
                    let mevcutOyuncular = snapshot.val() || {};
                    let gercekOyuncuSayisi = Object.values(mevcutOyuncular).filter(p => !p.isBot).length;
                    
                    if (gercekOyuncuSayisi >= kisiSayisi) {
                        alert('Bu oda dolu! Ba≈üka oda deneyin veya bekleyin.');
                        return;
                    }
                    
                    oyunuBaslat(kisiSayisi, odaAdi);
                });
            } else {
                oyunuBaslat(kisiSayisi, odaAdi);
            }
        }

        function oyunuBaslat(kisiSayisi, odaAdi) {
            oyunBaslamaZamani = Date.now();
            girisZamani = Date.now();
            
            const bonuses = getPlayerBonuses();
            ben.maxHp = AYARLAR.maxHp + bonuses.hp;
            ben.hp = ben.maxHp;
            ben.sonHasarZamani = Date.now();

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            showMobileControls(true);
            oyunAktif = true;

            if (botModuAktif) {
                takim = "mavi";
                ben.takim = takim;
                ben.isim = oyuncuIsmi;
                ben.girisZamani = girisZamani;
                ben.x = arena.x + 100;
                ben.y = arena.y + arena.h / 2;
                ben.equiped = userProfile.equiped || {};

                db.ref(odaAdi + "/" + myId).set(ben);
                db.ref(odaAdi + "/" + myId).onDisconnect().remove();

                db.ref(odaAdi).on('value', snapshot => {
                    oyuncular = snapshot.val() || {};
                    if(!oyuncular[myId]) oyuncular[myId] = ben;
                    if(oyuncular[myId]) {
                        if(oyuncular[myId].hp !== undefined) ben.hp = oyuncular[myId].hp;
                        if(oyuncular[myId].sonHasarZamani !== undefined) ben.sonHasarZamani = oyuncular[myId].sonHasarZamani;
                    }
                    arayuzGuncelle();
                    kazanmaKontrolu();
                });

                document.getElementById('room-info').innerHTML = "MODE: BOT";
                geriSayimYap(3);
                oyunDongusu();
                return;
            }

            ben.isim = oyuncuIsmi;
            ben.girisZamani = girisZamani;
            ben.takim = "bekliyor";
            ben.x = canvas.width / 2;
            ben.y = canvas.height / 2;
            ben.equiped = userProfile.equiped || {};

            db.ref(odaAdi).once('value').then(snapshot => {
                let mevcutOyuncular = snapshot.val() || {};
                
                Object.keys(mevcutOyuncular).forEach(key => {
                    if (mevcutOyuncular[key].isBot) db.ref(odaAdi + "/" + key).remove();
                });

                return db.ref(odaAdi + "/" + myId).set(ben);
            }).then(() => {
                db.ref(odaAdi + "/" + myId).onDisconnect().remove();

                db.ref(odaAdi).on('value', snapshot => {
                    oyuncular = snapshot.val() || {};
                    if(!oyuncular[myId]) oyuncular[myId] = ben;
                    if(oyuncular[myId]) {
                        if(oyuncular[myId].hp !== undefined) ben.hp = oyuncular[myId].hp;
                        if(oyuncular[myId].sonHasarZamani !== undefined) ben.sonHasarZamani = oyuncular[myId].sonHasarZamani;
                    }

                    let gercekOyuncular = Object.entries(oyuncular)
                        .filter(([k, p]) => !p.isBot)
                        .sort((a, b) => {
                            let zamanFark = (a[1].girisZamani || 0) - (b[1].girisZamani || 0);
                            if (zamanFark !== 0) return zamanFark;
                            return a[0].localeCompare(b[0]);
                        });

                    let benimIndex = gercekOyuncular.findIndex(([k, p]) => k === myId);
                    if (benimIndex !== -1) {
                        let yeniTakim = (benimIndex % 2 === 0) ? "mavi" : "kirmizi";
                        
                        if (ben.takim !== yeniTakim) {
                            ben.takim = yeniTakim;
                            takim = yeniTakim;
                            ben.x = takim === "mavi" ? arena.x + 100 : arena.x + arena.w - 100;
                            ben.y = arena.y + arena.h / 2;
                            db.ref(odaAdi + "/" + myId).update({ takim: yeniTakim, x: ben.x, y: ben.y });
                        }
                    }

                    arayuzGuncelle();
                    kazanmaKontrolu();
                });

                document.getElementById('room-info').innerHTML = "ROOM: " + hedefKisiSayisi + "P";
                geriSayimYap(3);
                oyunDongusu();
            });
        }

        function geriSayimYap(saniye) {
            let cd = document.getElementById('countdown');
            cd.style.opacity = 1;
            cd.innerText = "READY!";
            
            let sayac = saniye;
            let interval = setInterval(() => {
                if(sayac > 0) {
                    cd.innerText = sayac;
                    sayac--;
                } else {
                    cd.innerText = "FIGHT!";
                    oyunBasladi = true;
                    setTimeout(() => cd.style.opacity = 0, 1000);
                    clearInterval(interval);
                }
            }, 1000);
        }

        function cikisYap() {
            if(odaAdi) db.ref(odaAdi + "/" + myId).remove();
            location.reload(); 
        }

        function arayuzGuncelle() {
            let gercekOyuncular = Object.values(oyuncular).filter(p => !p.isBot);
            let maviTakim = gercekOyuncular.filter(p => p.takim === "mavi").map(p => p.isim || "?").join(",");
            let kirmiziTakim = gercekOyuncular.filter(p => p.takim === "kirmizi").map(p => p.isim || "?").join(",");
            
            if(botModuAktif) {
                let botSayi = Object.values(oyuncular).filter(p => p.isBot).length;
                document.getElementById('room-info').innerHTML = `MODE: BOT<br>ENEMY: ${botSayi}`;
            } else {
                document.getElementById('room-info').innerHTML = 
                    `<span style="color:${RENKLER.mavi}">BLU: ${maviTakim || "..."}</span><br>` +
                    `<span style="color:${RENKLER.kirmizi}">RED: ${kirmiziTakim || "..."}</span>`;
            }
        }

        function hpRegenKontrol() {
            if (ben.hp <= 0 || ben.hp >= ben.maxHp) {
                document.getElementById('regen-indicator').style.opacity = '0';
                return;
            }
            
            let simdi = Date.now();
            let sonHasardanGecenSure = simdi - ben.sonHasarZamani;
            
            if (sonHasardanGecenSure >= AYARLAR.regenSuresi) {
                document.getElementById('regen-indicator').style.opacity = '1';
                
                if (simdi - sonRegenZamani >= 1000) {
                    ben.hp = Math.min(ben.maxHp, ben.hp + AYARLAR.regenMiktari);
                    db.ref(odaAdi + "/" + myId + "/hp").set(ben.hp);
                    sonRegenZamani = simdi;
                    bildirimGoster("+HP");
                }
            } else {
                document.getElementById('regen-indicator').style.opacity = '0';
            }
        }

        let lastBotUpdate = 0;
        function botlariYonet() {
            if (!botModuAktif) return;

            let gercekOyuncular = Object.keys(oyuncular).filter(key => !oyuncular[key].isBot).sort();
            if (gercekOyuncular.length === 0 || gercekOyuncular[0] !== myId) return;

            let mevcutSayi = Object.keys(oyuncular).length;
            
            if (mevcutSayi < hedefKisiSayisi) {
                if (Math.random() < 0.3) { 
                    let botId = "bot_" + Date.now() + Math.floor(Math.random()*100);
                    let botIsimler = ["CPU1", "CPU2", "BOT", "NPC", "AI01", "ROBO"];
                    let rastgeleIsim = botIsimler[Math.floor(Math.random() * botIsimler.length)];

                    db.ref(odaAdi + "/" + botId).set({
                        x: arena.x + arena.w - 100, 
                        y: arena.y + arena.h / 2 + (Math.random() - 0.5) * 100, 
                        hp: 50, maxHp: 50, takim: "kirmizi", isBot: true, yon: -1, hareket: false, isim: rastgeleIsim,
                        sonHasarZamani: Date.now()
                    });
                }
            }

            if (Date.now() - lastBotUpdate > 60) {
                Object.keys(oyuncular).forEach(key => {
                    let p = oyuncular[key];
                    if (p.isBot && p.hp > 0) {
                        let enYakinDusmanKey = null, enYakinDusman = null, minMesafe = 9999;
                        
                        Object.keys(oyuncular).forEach(targetKey => {
                            let target = oyuncular[targetKey];
                            if (target.takim !== p.takim && target.hp > 0) {
                                let d = Math.sqrt((p.x - target.x)**2 + (p.y - target.y)**2);
                                if (d < minMesafe) { minMesafe = d; enYakinDusman = target; enYakinDusmanKey = targetKey; }
                            }
                        });

                        let updates = {};
                        
                        let botSonHasar = p.sonHasarZamani || Date.now();
                        if (Date.now() - botSonHasar >= AYARLAR.regenSuresi && p.hp < (p.maxHp || 50)) {
                            updates.hp = Math.min(p.maxHp || 50, p.hp + 0.1);
                        }
                        
                        if (enYakinDusman) {
                            let hiz = AYARLAR.botHiz;
                            if (enYakinDusman.x > p.x + 20) { p.x += hiz; p.yon = 1; p.hareket = true; }
                            else if (enYakinDusman.x < p.x - 20) { p.x -= hiz; p.yon = -1; p.hareket = true; }
                            if (enYakinDusman.y > p.y + 10) { p.y += hiz; p.hareket = true; }
                            else if (enYakinDusman.y < p.y - 10) { p.y -= hiz; p.hareket = true; }

                            p.x = Math.max(arena.x + 20, Math.min(arena.x + arena.w - 20, p.x));
                            p.y = Math.max(arena.y + 20, Math.min(arena.y + arena.h - 20, p.y));

                            if (minMesafe < 55 && !p.saldiriyor && Math.random() < 0.5) { 
                                updates.saldiriyor = true;
                                setTimeout(() => db.ref(odaAdi + "/" + key + "/saldiriyor").set(false), 350);
                                if (enYakinDusmanKey && oyuncular[enYakinDusmanKey]) {
                                    let hedefHp = oyuncular[enYakinDusmanKey].hp || 50;
                                    db.ref(odaAdi + "/" + enYakinDusmanKey + "/hp").set(Math.max(0, hedefHp - AYARLAR.botHasar));
                                    db.ref(odaAdi + "/" + enYakinDusmanKey + "/sonHasarZamani").set(Date.now());
                                }
                            }
                        } else { p.hareket = false; }
                        
                        updates.x = p.x; updates.y = p.y; updates.yon = p.yon; updates.hareket = p.hareket;
                        db.ref(odaAdi + "/" + key).update(updates);
                    }
                });
                lastBotUpdate = Date.now();
            }
        }

        function saldir() {
            if (ben.saldiriyor || ben.hp <= 0) return;
            ben.saldiriyor = true;
            guncelle();
            setTimeout(() => { ben.saldiriyor = false; guncelle(); }, 300);

            const bonuses = getPlayerBonuses();
            const toplamHasar = AYARLAR.oyuncuHasar + bonuses.hasar;

            Object.keys(oyuncular).forEach(key => {
                let rakip = oyuncular[key];
                if (key !== myId && rakip.hp > 0 && rakip.takim !== ben.takim) {
                    let d = Math.sqrt((rakip.x - ben.x)**2 + (rakip.y - ben.y)**2);
                    let yuzDonuk = (ben.yon === 1 && rakip.x > ben.x) || (ben.yon === -1 && rakip.x < ben.x);
                    if (d < 70 && yuzDonuk) { 
                        db.ref(odaAdi + "/" + key + "/hp").once('value').then(snapshot => {
                            let mevcutHp = snapshot.val() ?? 50;
                            db.ref(odaAdi + "/" + key + "/hp").set(Math.max(0, mevcutHp - toplamHasar));
                            db.ref(odaAdi + "/" + key + "/sonHasarZamani").set(Date.now());
                        });
                        bildirimGoster("HIT! -" + toplamHasar);
                    }
                }
            });
        }

        function guncelle() {
            db.ref(odaAdi + "/" + myId).update({
                x: ben.x, y: ben.y, yon: ben.yon, 
                hareket: ben.hp > 0 ? ben.hareket : false, 
                saldiriyor: ben.hp > 0 ? ben.saldiriyor : false, 
                takim: ben.takim, isim: ben.isim, girisZamani: ben.girisZamani,
                sonHasarZamani: ben.sonHasarZamani, maxHp: ben.maxHp,
                equiped: userProfile.equiped || {}
            });
        }

        function cizArena() {
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for(let i = 0; i < canvas.width; i += 16) {
                let renk = (Math.floor(i/16) % 3 === 0) ? '#3a2a4a' : '#2a1a3a';
                ctx.fillStyle = renk;
                ctx.fillRect(i, 0, 16, arena.y - 10);
                
                if(Math.random() > 0.7) {
                    ctx.fillStyle = ['#ff004d', '#29adff', '#ffec27', '#00e436'][Math.floor(Math.random()*4)];
                    ctx.fillRect(i + 4, arena.y - 25 + Math.sin(Date.now()/500 + i)*2, 6, 6);
                }
            }
            
            for(let i = 0; i < canvas.width; i += 16) {
                let renk = (Math.floor(i/16) % 3 === 0) ? '#3a2a4a' : '#2a1a3a';
                ctx.fillStyle = renk;
                ctx.fillRect(i, arena.y + arena.h + 10, 16, canvas.height);
            }
            
            ctx.fillStyle = '#4a3a5a';
            for(let x = arena.x - 16; x <= arena.x + arena.w; x += 16) {
                ctx.fillRect(x, arena.y - 16, 16, 16);
            }
            for(let x = arena.x - 16; x <= arena.x + arena.w; x += 16) {
                ctx.fillRect(x, arena.y + arena.h, 16, 16);
            }
            for(let y = arena.y; y <= arena.y + arena.h; y += 16) {
                ctx.fillRect(arena.x - 16, y, 16, 16);
            }
            for(let y = arena.y; y <= arena.y + arena.h; y += 16) {
                ctx.fillRect(arena.x + arena.w, y, 16, 16);
            }
            
            ctx.fillStyle = '#3d2b1f';
            ctx.fillRect(arena.x, arena.y, arena.w, arena.h);
            
            for(let x = arena.x; x < arena.x + arena.w; x += 32) {
                for(let y = arena.y; y < arena.y + arena.h; y += 32) {
                    ctx.fillStyle = '#4d3b2f';
                    ctx.fillRect(x + 8, y + 8, 4, 4);
                    ctx.fillRect(x + 20, y + 16, 4, 4);
                }
            }
            
            ctx.fillStyle = '#5d4b3f';
            ctx.fillRect(arena.x + arena.w/2 - 2, arena.y, 4, arena.h);
            
            ctx.strokeStyle = '#5d4b3f';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.arc(arena.x + arena.w/2, arena.y + arena.h/2, Math.min(arena.w, arena.h) * 0.15, 0, Math.PI * 2);
            ctx.stroke();
            
            cizMesale(arena.x + 20, arena.y + 20);
            cizMesale(arena.x + arena.w - 20, arena.y + 20);
            cizMesale(arena.x + 20, arena.y + arena.h - 20);
            cizMesale(arena.x + arena.w - 20, arena.y + arena.h - 20);
            
            ctx.fillStyle = '#ffec27';
            ctx.font = "10px 'Press Start 2P'";
            ctx.textAlign = "center";
            ctx.fillText("‚öî BATTLE ARENA ‚öî", canvas.width/2, arena.y - 25);
            
            ctx.fillStyle = 'rgba(41, 173, 255, 0.1)';
            ctx.fillRect(arena.x, arena.y, arena.w * 0.3, arena.h);
            ctx.fillStyle = 'rgba(255, 0, 77, 0.1)';
            ctx.fillRect(arena.x + arena.w * 0.7, arena.y, arena.w * 0.3, arena.h);
        }
        
        function cizMesale(x, y) {
            ctx.fillStyle = '#5f574f';
            ctx.fillRect(x - 2, y, 4, 16);
            let time = Date.now();
            let flicker = Math.sin(time / 100) * 2;
            ctx.fillStyle = '#ffa300';
            ctx.fillRect(x - 4, y - 8 + flicker, 8, 8);
            ctx.fillStyle = '#ffec27';
            ctx.fillRect(x - 2, y - 10 + flicker, 4, 6);
        }

        function oyunDongusu() {
            if (!oyunAktif) return;
            
            cizArena();

            if (ben.hp > 0) {
                let hareket = false;
                const bonuses = getPlayerBonuses();
                let hiz = AYARLAR.oyuncuHiz + bonuses.hiz;
                
                // Joystick kontrol√º
                if (joystickActive) {
                    if (Math.abs(joystickData.x) > 0.2) {
                        ben.x += joystickData.x * hiz;
                        ben.yon = joystickData.x > 0 ? 1 : -1;
                        hareket = true;
                    }
                    if (Math.abs(joystickData.y) > 0.2) {
                        ben.y += joystickData.y * hiz;
                        hareket = true;
                    }
                }
                
                // Klavye kontrol√º
                if (tuslar['w'] || tuslar['ArrowUp']) { ben.y -= hiz; hareket = true; }
                if (tuslar['s'] || tuslar['ArrowDown']) { ben.y += hiz; hareket = true; }
                if (tuslar['a'] || tuslar['ArrowLeft']) { ben.x -= hiz; ben.yon = -1; hareket = true; }
                if (tuslar['d'] || tuslar['ArrowRight']) { ben.x += hiz; ben.yon = 1; hareket = true; }
                
                ben.x = Math.max(arena.x + 20, Math.min(arena.x + arena.w - 20, ben.x));
                ben.y = Math.max(arena.y + 20, Math.min(arena.y + arena.h - 20, ben.y));
                ben.hareket = hareket;
                guncelle(); 
                hpRegenKontrol();
            } else {
                guncelle();
            }

            let barW = Math.max(0, (ben.hp / ben.maxHp) * 100);
            document.getElementById('health-bar').style.width = barW + "%";
            document.getElementById('health-bar').style.background = ben.hp > ben.maxHp * 0.5 ? RENKLER.yesil : RENKLER.kirmizi;
            document.getElementById('health-text').innerText = "HP: " + Math.max(0, Math.ceil(ben.hp)) + "/" + ben.maxHp;

            botlariYonet();
            
            let cizimSirasi = Object.entries(oyuncular).sort((a,b) => (a[1].hp <= 0 ? -1 : 1));
            cizimSirasi.forEach(([key, p]) => cizPixelKarakter(p, key));
            
            requestAnimationFrame(oyunDongusu);
        }

        function cizPixelKarakter(p, key) {
            let x = Math.floor(p.x);
            let y = Math.floor(p.y);
            let renk = p.takim === "mavi" ? RENKLER.mavi : RENKLER.kirmizi;
            let renkKoyu = p.takim === "mavi" ? '#1d6fa5' : '#7e0026';
            
            ctx.save();
            if (p.hp <= 0) ctx.globalAlpha = 0.5;
            
            let yon = p.yon || 1;
            let time = Date.now();
            let bounce = p.hareket ? Math.sin(time / 100) * 2 : 0;
            let saldiriOffset = p.saldiriyor ? 10 * yon : 0;
            
            // Ekipman kontrol√º
            let equiped = p.equiped || {};
            let hasArmor = equiped.zirh;
            let hasHelmet = equiped.kask;
            let hasSword = equiped.silah;
            let hasBoots = equiped.bot;
            
            // G√ñLGE
            ctx.fillStyle = 'rgba(0,0,0,0.4)';
            ctx.fillRect(x - 10, y + 22, 20, 6);
            
            // BACAKLAR
            ctx.fillStyle = hasBoots ? '#ffa300' : renkKoyu;
            if (p.hp > 0) {
                let bacakOffset = p.hareket ? Math.sin(time / 80) * 4 : 0;
                ctx.fillRect(x - 6 + bacakOffset, y + 8 + bounce, 4, 14);
                ctx.fillRect(x + 2 - bacakOffset, y + 8 + bounce, 4, 14);
            } else {
                ctx.fillRect(x - 6, y + 8, 4, 14);
                ctx.fillRect(x + 2, y + 8, 4, 14);
            }
            
            // G√ñVDE (Zƒ±rh varsa farklƒ± renk)
            ctx.fillStyle = hasArmor ? '#c2c3c7' : renk;
            ctx.fillRect(x - 8, y - 8 + bounce, 16, 18);
            
            if (hasArmor) {
                ctx.fillStyle = '#83769c';
                ctx.fillRect(x - 6, y - 4 + bounce, 12, 2);
                ctx.fillRect(x - 6, y + 2 + bounce, 12, 2);
            }
            
            // KAFA
            ctx.fillStyle = RENKLER.krem;
            ctx.fillRect(x - 6, y - 22 + bounce, 12, 14);
            
            // KASK (varsa altƒ±n rengi)
            ctx.fillStyle = hasHelmet ? '#ffcc00' : renkKoyu;
            ctx.fillRect(x - 8, y - 26 + bounce, 16, 6);
            ctx.fillStyle = hasHelmet ? '#ffa300' : renk;
            ctx.fillRect(x - 6, y - 24 + bounce, 12, 4);
            
            // G√ñZLER
            if (p.hp > 0) {
                ctx.fillStyle = RENKLER.siyah;
                ctx.fillRect(x - 3 + (yon > 0 ? 2 : 0), y - 16 + bounce, 2, 3);
                ctx.fillRect(x + 3 + (yon > 0 ? 2 : 0), y - 16 + bounce, 2, 3);
            } else {
                ctx.fillStyle = RENKLER.kirmizi;
                ctx.fillRect(x - 4, y - 16, 2, 2);
                ctx.fillRect(x - 2, y - 14, 2, 2);
                ctx.fillRect(x + 2, y - 16, 2, 2);
                ctx.fillRect(x + 4, y - 14, 2, 2);
            }
            
            // KOLLAR
            ctx.fillStyle = RENKLER.krem;
            if (yon > 0) {
                ctx.fillRect(x - 14, y - 6 + bounce, 6, 12);
                ctx.fillRect(x + 8 + saldiriOffset, y - 6 + bounce, 6, 12);
            } else {
                ctx.fillRect(x + 8, y - 6 + bounce, 6, 12);
                ctx.fillRect(x - 14 + saldiriOffset, y - 6 + bounce, 6, 12);
            }
            
            // KILI√á (√ñzel kƒ±lƒ±√ß varsa farklƒ± renk/boyut)
            if (p.hp > 0) {
                let swordColor = hasSword ? (hasSword === 'sword3' ? '#ff004d' : '#ffcc00') : RENKLER.acik_gri;
                let swordLength = hasSword ? 28 : 24;
                
                ctx.fillStyle = '#5f574f';
                if (yon > 0) {
                    ctx.fillRect(x + 14 + saldiriOffset, y + 4 + bounce, 6, 8);
                } else {
                    ctx.fillRect(x - 20 + saldiriOffset, y + 4 + bounce, 6, 8);
                }
                
                ctx.fillStyle = swordColor;
                if (yon > 0) {
                    ctx.fillRect(x + 16 + saldiriOffset, y - 16 + bounce, 4, swordLength);
                    ctx.fillStyle = RENKLER.beyaz;
                    ctx.fillRect(x + 17 + saldiriOffset, y - 14 + bounce, 2, swordLength - 4);
                } else {
                    ctx.fillRect(x - 20 + saldiriOffset, y - 16 + bounce, 4, swordLength);
                    ctx.fillStyle = RENKLER.beyaz;
                    ctx.fillRect(x - 19 + saldiriOffset, y - 14 + bounce, 2, swordLength - 4);
                }
                
                // √áift kƒ±lƒ±√ß efekti
                if (hasSword === 'sword2' || hasSword === 'sword3') {
                    ctx.fillStyle = swordColor;
                    if (yon > 0) {
                        ctx.fillRect(x - 20, y - 12 + bounce, 4, 20);
                    } else {
                        ctx.fillRect(x + 16, y - 12 + bounce, 4, 20);
                    }
                }
                
                if (p.saldiriyor) {
                    ctx.fillStyle = hasSword === 'sword3' ? 'rgba(255, 100, 50, 0.6)' : 'rgba(255, 255, 200, 0.5)';
                    if (yon > 0) {
                        ctx.fillRect(x + 20 + saldiriOffset, y - 10 + bounce, 25, 4);
                    } else {
                        ctx.fillRect(x - 45 + saldiriOffset, y - 10 + bounce, 25, 4);
                    }
                }
            }
            
            // KALKAN
            ctx.fillStyle = renkKoyu;
            if (yon > 0) {
                ctx.fillRect(x - 18, y - 4 + bounce, 6, 14);
                ctx.fillStyle = renk;
                ctx.fillRect(x - 17, y - 2 + bounce, 4, 10);
            } else {
                ctx.fillRect(x + 12, y - 4 + bounce, 6, 14);
                ctx.fillStyle = renk;
                ctx.fillRect(x + 13, y - 2 + bounce, 4, 10);
            }
            
            // HP BAR
            let maxHp = p.maxHp || 50;
            if (p.hp > 0) {
                ctx.fillStyle = RENKLER.siyah;
                ctx.fillRect(x - 14, y - 36, 28, 8);
                ctx.fillStyle = p.hp > maxHp * 0.5 ? RENKLER.yesil : RENKLER.kirmizi;
                ctx.fillRect(x - 13, y - 35, (p.hp / maxHp) * 26, 6);
                
                let sonHasar = p.sonHasarZamani || 0;
                if (Date.now() - sonHasar >= AYARLAR.regenSuresi && p.hp < maxHp) {
                    ctx.fillStyle = `rgba(0, 228, 54, ${0.3 + Math.sin(Date.now() / 200) * 0.3})`;
                    ctx.fillRect(x - 14, y - 36, 28, 8);
                }
            }
            
            // ƒ∞Sƒ∞M
            ctx.fillStyle = RENKLER.beyaz;
            ctx.font = "8px 'Press Start 2P'";
            ctx.textAlign = "center";
            let isim = p.isim || (p.isBot ? "CPU" : "???");
            if (key === myId) isim = ">" + isim + "<";
            ctx.fillText(isim, x, y - 42);
            
            ctx.restore();
        }

        function bildirimGoster(mesaj) {
            let n = document.getElementById('notification');
            n.innerText = mesaj; n.style.opacity = 1;
            setTimeout(() => n.style.opacity = 0, 500);
        }

        function kazanmaKontrolu() {
            if (!oyunBasladi) return;

            let m = 0, k = 0;
            Object.values(oyuncular).forEach(p => {
                if (p.hp > 0) { 
                    if (p.takim === "mavi") m++; 
                    else if (p.takim === "kirmizi") k++; 
                }
            });

            let ekran = document.getElementById('gameOverScreen');
            if (ekran.style.display !== 'none') return; 

            let mainText = document.getElementById('winnerText');
            let subText = document.getElementById('subWinner');
            let scoreGain = document.getElementById('scoreGain');
            
            let kazananTakim = "";
            if (m === 0 && k > 0) kazananTakim = "kirmizi";
            else if (k === 0 && m > 0) kazananTakim = "mavi";
            
            if (kazananTakim !== "") {
                if (ben.takim === kazananTakim) {
                    mainText.innerText = "VICTORY!";
                    mainText.style.color = RENKLER.yesil; 
                    subText.innerText = oyuncuIsmi + " KAZANDI!";
                    
                    // PUAN EKLE
                    userProfile.puan = (userProfile.puan || 0) + AYARLAR.galibiyetPuani;
                    saveUserProfile();
                    scoreGain.innerText = "+" + AYARLAR.galibiyetPuani + " PUAN! (Toplam: " + userProfile.puan + ")";
                    
                    // √ñd√ºl kontrol√º
                    checkRewards();
                } else {
                    mainText.innerText = "DEFEAT";
                    mainText.style.color = RENKLER.kirmizi; 
                    subText.innerText = "YENƒ∞LDƒ∞N...";
                    scoreGain.innerText = "";
                }
                oyunBitti();
            }
        }

        function checkRewards() {
            // Otomatik √∂d√ºl a√ßma (50 ve 100 puan)
            if (userProfile.puan >= 50 && !userProfile.sahipOlunanlar?.includes('sword2')) {
                if (!userProfile.sahipOlunanlar) userProfile.sahipOlunanlar = [];
                userProfile.sahipOlunanlar.push('sword2');
                saveUserProfile();
                setTimeout(() => alert('üéâ 50 PUAN √ñD√úL√ú: √áƒ∞FT KILI√á A√áILDI!'), 500);
            }
            if (userProfile.puan >= 100 && !userProfile.sahipOlunanlar?.includes('armor1')) {
                if (!userProfile.sahipOlunanlar) userProfile.sahipOlunanlar = [];
                userProfile.sahipOlunanlar.push('armor1');
                saveUserProfile();
                setTimeout(() => alert('üéâ 100 PUAN √ñD√úL√ú: DEMƒ∞R ZIRH A√áILDI!'), 1000);
            }
        }

        function oyunBitti() {
            oyunAktif = false;
            showMobileControls(false);
            setTimeout(() => {
                document.getElementById('gameOverScreen').style.display = 'flex';
                document.getElementById('ui-layer').style.display = 'none';
            }, 1500); 
        }
    </script>
</body>
</html>
